{"config":{"lang":["en"],"prebuild_index":false,"separator":"[\\s\\-]+"},"docs":[{"location":"","text":"Welcome \u00b6 Hello world. It's Rammus, yo!","title":"Welcome"},{"location":"#welcome","text":"Hello world. It's Rammus, yo!","title":"Welcome"},{"location":"help/","text":"Help \u00b6 Tips about writing in mkdocs. mkdocs.org mkdocs-material codehilite admonition - note block Pymdown Writing in Visual Studio Code Tabs \u00b6 This need pymdownx.superfences ``` bash tab = echo hi ``` ``` py tab = print ( 'hi' ) ``` bash echo hi py print ( 'hi' ) Hightlight \u00b6 This need pymdownx.mark This is a ==highlight==. This is a highlight . Highlight Code \u00b6 ```yaml hl_lines=\"9 10 11 17\" kind: Service apiVersion: v1 metadata: name: dnsmasq spec: selector: name: dnsmasq type: LoadBalancer externalIPs: - a.a.a.a - a.a.a.b ports: - name: dnsmasq-udp port: 53 protocol: UDP targetPort: dnsmasq-udp # loadBalancerIP: a.a.a.a ``` kind : Service apiVersion : v1 metadata : name : dnsmasq spec : selector : name : dnsmasq type : LoadBalancer externalIPs : - a.a.a.a - a.a.a.b ports : - name : dnsmasq-udp port : 53 protocol : UDP targetPort : dnsmasq-udp # loadBalancerIP: a.a.a.a Escape ``` in markdown \u00b6 Wrap it by one more ` ```` ```yaml kind : Service apiVersion : v1 metadata : name : dnsmasq ``` ```` ```yaml kind : Service apiVersion : v1 metadata : name : dnsmasq ``` Link(reference) to internal documents \u00b6 [ Writing in Visual Studio Code ]( snippets / visual - studio . md ) [ Mac Setup ]( mac - setup . md ) [ Help ](.. / help . md )","title":"Help"},{"location":"help/#help","text":"Tips about writing in mkdocs. mkdocs.org mkdocs-material codehilite admonition - note block Pymdown Writing in Visual Studio Code","title":"Help"},{"location":"help/#tabs","text":"This need pymdownx.superfences ``` bash tab = echo hi ``` ``` py tab = print ( 'hi' ) ``` bash echo hi py print ( 'hi' )","title":"Tabs"},{"location":"help/#hightlight","text":"This need pymdownx.mark This is a ==highlight==. This is a highlight .","title":"Hightlight"},{"location":"help/#highlight-code","text":"```yaml hl_lines=\"9 10 11 17\" kind: Service apiVersion: v1 metadata: name: dnsmasq spec: selector: name: dnsmasq type: LoadBalancer externalIPs: - a.a.a.a - a.a.a.b ports: - name: dnsmasq-udp port: 53 protocol: UDP targetPort: dnsmasq-udp # loadBalancerIP: a.a.a.a ``` kind : Service apiVersion : v1 metadata : name : dnsmasq spec : selector : name : dnsmasq type : LoadBalancer externalIPs : - a.a.a.a - a.a.a.b ports : - name : dnsmasq-udp port : 53 protocol : UDP targetPort : dnsmasq-udp # loadBalancerIP: a.a.a.a","title":"Highlight Code"},{"location":"help/#escape-in-markdown","text":"Wrap it by one more ` ```` ```yaml kind : Service apiVersion : v1 metadata : name : dnsmasq ``` ```` ```yaml kind : Service apiVersion : v1 metadata : name : dnsmasq ```","title":"Escape ``` in markdown"},{"location":"help/#linkreference-to-internal-documents","text":"[ Writing in Visual Studio Code ]( snippets / visual - studio . md ) [ Mac Setup ]( mac - setup . md ) [ Help ](.. / help . md )","title":"Link(reference) to internal documents"},{"location":"snippets/bash/","text":"Bash \u00b6 Date \u00b6 DATE = $( date +%Y%m%d_%H%M%S ) FILE = \"/backup/backup- $DATE \" Varaible \u00b6 \b\b\u8a2d\u5b9a/\u522a\u9664 \u00b6 export A_VARIBALE unset A_VARIBALE \u4f7f\u7528\u9810\u8a2d\u503c \u00b6 ACTOR = $ { ACTOR :- $ GITHUB_ACTOR } qq = ops:default echo ${ qq #*: } # default echo ${ qq %:* } # ops \u66ab\u6642\u9032\u5230\u67d0\u500b folder \u57f7\u884c\u6307\u4ee4\uff0c\u4e0d\u6539\u8b8a\u76ee\u524d path \u00b6 ( cd src/ && git checkout $NEW_VERSION_SHA ) ANSI - \u8f38\u51fa\u6587\u5b57\u8b8a\u8272 \u00b6 https://misc.flogisoft.com/bash/tip_colors_and_formatting echo -e \"Default \\e[31mRed\" echo -e \"\\e[31mHello\\e[0m World\" echo -e \"\\e[1;31mHello\\e[0m World\" -e : to use \\e[31m Reference \u00b6 https://devhints.io/bash","title":"Bash"},{"location":"snippets/bash/#bash","text":"","title":"Bash"},{"location":"snippets/bash/#date","text":"DATE = $( date +%Y%m%d_%H%M%S ) FILE = \"/backup/backup- $DATE \"","title":"Date"},{"location":"snippets/bash/#varaible","text":"","title":"Varaible"},{"location":"snippets/bash/#_1","text":"export A_VARIBALE unset A_VARIBALE","title":"\b\b\u8a2d\u5b9a/\u522a\u9664"},{"location":"snippets/bash/#_2","text":"ACTOR = $ { ACTOR :- $ GITHUB_ACTOR } qq = ops:default echo ${ qq #*: } # default echo ${ qq %:* } # ops","title":"\u4f7f\u7528\u9810\u8a2d\u503c"},{"location":"snippets/bash/#folder-path","text":"( cd src/ && git checkout $NEW_VERSION_SHA )","title":"\u66ab\u6642\u9032\u5230\u67d0\u500b folder \u57f7\u884c\u6307\u4ee4\uff0c\u4e0d\u6539\u8b8a\u76ee\u524d path"},{"location":"snippets/bash/#ansi-","text":"https://misc.flogisoft.com/bash/tip_colors_and_formatting echo -e \"Default \\e[31mRed\" echo -e \"\\e[31mHello\\e[0m World\" echo -e \"\\e[1;31mHello\\e[0m World\" -e : to use \\e[31m","title":"ANSI - \u8f38\u51fa\u6587\u5b57\u8b8a\u8272"},{"location":"snippets/bash/#reference","text":"https://devhints.io/bash","title":"Reference"},{"location":"snippets/docker-compose/","text":"Docker Compose \u00b6 version : '3' services : web : build : . ports : - \"5000:5000\" redis : image : \"redis:alpine\" networks : - frontend networks : frontend : name : custom_frontend Connect to redis \u00b6 version : '3' services : redis : image : \"redis:alpine\" ports : - \"6379:6379\" celery : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis celery-2 : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis docker exec -it celery_celery_1 ping redis docker exec -it celery_celery_1 ping redis-not-found Reference \u00b6 https://docs.docker.com/compose/compose-file/","title":"Docker Compose"},{"location":"snippets/docker-compose/#docker-compose","text":"version : '3' services : web : build : . ports : - \"5000:5000\" redis : image : \"redis:alpine\" networks : - frontend networks : frontend : name : custom_frontend","title":"Docker Compose"},{"location":"snippets/docker-compose/#connect-to-redis","text":"version : '3' services : redis : image : \"redis:alpine\" ports : - \"6379:6379\" celery : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis celery-2 : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis docker exec -it celery_celery_1 ping redis docker exec -it celery_celery_1 ping redis-not-found","title":"Connect to redis"},{"location":"snippets/docker-compose/#reference","text":"https://docs.docker.com/compose/compose-file/","title":"Reference"},{"location":"snippets/docker/","text":"Minimize docker image \u00b6 Delete libraries only used in build time \u00b6 apk update \\ && apk add --no-cache --virtual .build-deps curl \\ && curl -sL $TOOL_URL | gzip -d - > /usr/local/bin/new_tool \\ && chmod +x /usr/local/bin/new_tool \\ && apk del .build-deps","title":"Docker"},{"location":"snippets/docker/#minimize-docker-image","text":"","title":"Minimize docker image"},{"location":"snippets/docker/#delete-libraries-only-used-in-build-time","text":"apk update \\ && apk add --no-cache --virtual .build-deps curl \\ && curl -sL $TOOL_URL | gzip -d - > /usr/local/bin/new_tool \\ && chmod +x /usr/local/bin/new_tool \\ && apk del .build-deps","title":"Delete libraries only used in build time"},{"location":"snippets/elasticsearch/","text":"Status \u00b6 curl elasticsearch - client . elasticsearch : 9200 URL = \"localhost:9200\" URL = \"elasticsearch-client:9200\" curl - X GET $ URL / curl - X GET \"$URL/_cat/health?v\" curl - X GET \"$URL/_cat/nodes?v\" curl - X GET \"$URL/_cat/indices?v\" curl - X GET \"$URL/_cat/allocation?v\" curl - X GET \"$URL/_cat/shards?v\" curl - X GET \"$URL/_all/_settings?pretty\" curl - X GET http : // $ URL / _nodes / jvm ? pretty curl - X GET http : // $ URL / _nodes / process ? pretty curl - X GET \"$URL/_nodes/stats?pretty\" curl - X GET \"$URL/_nodes/nodeId1,nodeId2/stats\" curl - X GET \"$URL/_nodes/elasticsearch-data-2/stats\" curl - X GET $ URL / _cluster / health ? pretty curl - X GET $ URL / _cluster / settings ? pretty # Check jvm curl - X GET \"$URL/_nodes/stats/jvm?pretty\" curl - X GET \"$URL/_nodes/stats/jvm?pretty\" | grep heap_used_in_bytes CRUD \u00b6 URL = \"elasticsearch-client:9200\" curl - X PUT \"$URL/customer?pretty\" curl - X PUT \"$URL/customer/_doc/1?pretty\" - H 'Content-Type: application/json' - d ' { \"name\": \"John Doe\" } ' curl - X GET \"$URL/customer/_doc/1?pretty\" curl - X GET \"$URL/_cat/indices?v\" curl - X DELETE $ URL / Plugin \u00b6 / bin / elasticsearch - plugin install https : // github . com / medcl / elasticsearch - analysis - ik / releases / download / v7 . 0 . 0 / elasticsearch - analysis - ik - 7 . 0 . 0 . zip curl - X GET \"$URL/_cat/plugins?v&s=component&h=name,component,version,description\" curl - X GET \"$URL/_cat/plugins\" Benchmark \u00b6 esrally --track=geonames --pipeline=benchmark-only --target-hosts=elasticsearch-client:9200 esrally --track=pmc --pipeline=benchmark-only --target-hosts=elasticsearch-client:9200","title":"Elasticsearch"},{"location":"snippets/elasticsearch/#status","text":"curl elasticsearch - client . elasticsearch : 9200 URL = \"localhost:9200\" URL = \"elasticsearch-client:9200\" curl - X GET $ URL / curl - X GET \"$URL/_cat/health?v\" curl - X GET \"$URL/_cat/nodes?v\" curl - X GET \"$URL/_cat/indices?v\" curl - X GET \"$URL/_cat/allocation?v\" curl - X GET \"$URL/_cat/shards?v\" curl - X GET \"$URL/_all/_settings?pretty\" curl - X GET http : // $ URL / _nodes / jvm ? pretty curl - X GET http : // $ URL / _nodes / process ? pretty curl - X GET \"$URL/_nodes/stats?pretty\" curl - X GET \"$URL/_nodes/nodeId1,nodeId2/stats\" curl - X GET \"$URL/_nodes/elasticsearch-data-2/stats\" curl - X GET $ URL / _cluster / health ? pretty curl - X GET $ URL / _cluster / settings ? pretty # Check jvm curl - X GET \"$URL/_nodes/stats/jvm?pretty\" curl - X GET \"$URL/_nodes/stats/jvm?pretty\" | grep heap_used_in_bytes","title":"Status"},{"location":"snippets/elasticsearch/#crud","text":"URL = \"elasticsearch-client:9200\" curl - X PUT \"$URL/customer?pretty\" curl - X PUT \"$URL/customer/_doc/1?pretty\" - H 'Content-Type: application/json' - d ' { \"name\": \"John Doe\" } ' curl - X GET \"$URL/customer/_doc/1?pretty\" curl - X GET \"$URL/_cat/indices?v\" curl - X DELETE $ URL /","title":"CRUD"},{"location":"snippets/elasticsearch/#plugin","text":"/ bin / elasticsearch - plugin install https : // github . com / medcl / elasticsearch - analysis - ik / releases / download / v7 . 0 . 0 / elasticsearch - analysis - ik - 7 . 0 . 0 . zip curl - X GET \"$URL/_cat/plugins?v&s=component&h=name,component,version,description\" curl - X GET \"$URL/_cat/plugins\"","title":"Plugin"},{"location":"snippets/elasticsearch/#benchmark","text":"esrally --track=geonames --pipeline=benchmark-only --target-hosts=elasticsearch-client:9200 esrally --track=pmc --pipeline=benchmark-only --target-hosts=elasticsearch-client:9200","title":"Benchmark"},{"location":"snippets/gcp/","text":"GCP \u00b6 k8s \u00b6 gcloud components update gcloud container clusters list gcloud container clusters get-credentials staging --region = asia-east1 kubectl config get-contexts kubectl config use-context production kubectl config set-context --current --namespace = dev Create static ip address \u00b6 ref: https://cloud.google.com/kubernetes-engine/docs/tutorials/configuring-domain-name-static-ip gcloud compute addresses create dnsmasq-ip-2 --region asia-east1 gcloud compute addresses describe dnsmasq-ip-2 --region asia-east1 GCS(Google Cloud Stroge) \u00b6 Public to internet \u00b6 Edit bucket permissions -> Add member -> allUsers: Storage Object Viewer Test service accout permission \u00b6 SA = $( cat service-account.json | base64 ) docker run -it --rm --entrypoint bash gcr.io/cloud-builders/gsutil -c \" echo $SA | base64 -d > sa.json gcloud auth activate-service-account --key-file=sa.json bash \" gsutil ls gs://<replace_this_with_your_bucket>","title":"GCP"},{"location":"snippets/gcp/#gcp","text":"","title":"GCP"},{"location":"snippets/gcp/#k8s","text":"gcloud components update gcloud container clusters list gcloud container clusters get-credentials staging --region = asia-east1 kubectl config get-contexts kubectl config use-context production kubectl config set-context --current --namespace = dev","title":"k8s"},{"location":"snippets/gcp/#create-static-ip-address","text":"ref: https://cloud.google.com/kubernetes-engine/docs/tutorials/configuring-domain-name-static-ip gcloud compute addresses create dnsmasq-ip-2 --region asia-east1 gcloud compute addresses describe dnsmasq-ip-2 --region asia-east1","title":"Create static ip address"},{"location":"snippets/gcp/#gcsgoogle-cloud-stroge","text":"","title":"GCS(Google Cloud Stroge)"},{"location":"snippets/gcp/#public-to-internet","text":"Edit bucket permissions -> Add member -> allUsers: Storage Object Viewer","title":"Public to internet"},{"location":"snippets/gcp/#test-service-accout-permission","text":"SA = $( cat service-account.json | base64 ) docker run -it --rm --entrypoint bash gcr.io/cloud-builders/gsutil -c \" echo $SA | base64 -d > sa.json gcloud auth activate-service-account --key-file=sa.json bash \" gsutil ls gs://<replace_this_with_your_bucket>","title":"Test service accout permission"},{"location":"snippets/github-action/","text":"Github Action \u00b6 Github Actions(CI/CD) tricks that official documents didn't mention. This post including hints, tips, snippet, cheatsheet, troubleshooting, notes, how-to. Starter \u00b6 on : push : jobs : test : runs-on : ubuntu-latest steps : - uses : actions/checkout@v2 - name : Run tests run : | echo hi On trigger event \u00b6 on : push : branches : - \"master\" - \"**\" tags : - \"**\" pull_request : branches : - master repository_dispatch : types : [ rammus_post ] Important pull_request.branches is base on ref , not head_ref Environments and variables \u00b6 Pass variables \u00b6 echo ::set-output name = message:: $output_message echo ::set-env name = action_state::yellow Use variables \u00b6 GITHUB_TOKEN : ${{ secrets.GITHUB_TOKEN }} PR_COMMENT_URL : ${{ github.event.pull_request.comments_url }} PR_COMMENT : ${{ steps.message.outputs.message }} PAYLOAD_ACTOR : ${{ github.event.client_payload.actor }} Use GITHUB_ACTOR as git commit author and using github avator \u00b6 https://help.github.com/en/github/setting-up-and-managing-your-github-user-account/setting-your-commit-email-address git config --global user.name \"${GITHUB_ACTOR}\" git config --global user.email \"${GITHUB_ACTOR}@users.noreply.github.com\" remote_repo=\"https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git\" git remote add origin \"${remote_repo}\" Get commit author information \u00b6 This is only for push event AUTHOR_NAME : ${{ github.event.head_commit.author.name }} AUTHOR_EMAIL : ${{ github.event.head_commit.author.email }} if condition \u00b6 if : contains(github.ref, 'tags') if : steps.git-diff.outputs.is-diff if : steps.set-env.outputs.message == 'hello' if : github.ref != 'refs/heads/master' pull_request \u00b6 when specific event type \u00b6 if : github.event_name == 'pull_request' && github.event.action == 'unassigned' when branch name is \u00b6 if : github.event_name == 'pull_request' && contains(github.head_ref, 'my-feature-branch') when merged \u00b6 on : pull_request : types : [ closed ] jobs : merged : if : github.event.pull_request.merged == true Setting \u00b6 ACTIONS_RUNNER_DEBUG : true Build an action \u00b6 # action.yml name : 'Hello World' description : 'Greet someone and record the time' inputs : who-to-greet : # id of input description : 'Who to greet' required : true default : 'World' outputs : time : # id of output description : 'The time we greeted you' runs : using : 'docker' image : 'Dockerfile' args : - ${{ inputs.who-to-greet }} Get input as environemnt in Docker \u00b6 # action.yaml inputs : who-to-greet : # workflow.yaml - uses : ./actions/my-action with : who-to-greet : rammus # entrypoint.sh echo INPUTS_WHO_TO_GREET ENTRYPOINT need to be abolute path \u00b6 Warning When uses: ./actions/my-action Workflow will mount workspace --workdir /github/workspace COPY ./app.py / ENTRYPOINT python /app.py Awesome Actions \u00b6 Customize action type with http post method \u00b6 on : repository_dispatch : types : [ rammus_post ] jobs : rammus_job : env : ACTOR : ${{ github.event.client_payload.actor }} if : github.event.action == 'rammus_post' And you can send a post request like: INPUT_GITHUB_TOKEN = INPUT_COMMENT_URL = \"https://api.github.com/repos/<owner>/<repo>/dispatches\" curl -H \"Authorization: token $INPUT_GITHUB_TOKEN \" \\ -H \"Accept: application/vnd.github.everest-preview+json\" \\ -d '{\"event_type\":\"rammus_post\",\"client_payload\":{\"new_version_image\":\"echo-server:96b2166\", \"new_version_sha\":\"96b2166\",\"actor\":\"Rammus Xu\"}}' \\ -XPOST $INPUT_COMMENT_URL Docker login \u00b6 - name : Docker Login - docker.pkg.github.com uses : swaglive/actions/docker/login@944b742 with : password : ${{ secrets.GHR_PASSWORD }} username : ${{ secrets.GHR_USERNAME }} url : docker.pkg.github.com - name : Docker Login - docker.pkg.github.com if : contains(github.ref, 'tags') env : DOCKER_PASSWORD : ${{ secrets.GITHUB_TOKEN }} run : echo $DOCKER_PASSWORD | docker login -u $GITHUB_ACTOR --password-stdin docker.pkg.github.com Docker login and copy config to default container's workspace \u00b6 Note github runner will mount /home/runner/work/_temp/_github_home\":\"/github/home when we use a docker action. That means we can't use the credential directly in next steps. Only if you use a docker contain step. Since id: generate-mirror-list need docker credentials and run on default container, credentials should be copied to default container's home. And a docker action must run as root. Therefore, it needs to be sudo in a default container. - name : Docker Login - docker.pkg.github.com uses : swaglive/actions/docker/login@944b742 with : password : ${{ secrets.GHR_PASSWORD }} username : ${{ secrets.GHR_USERNAME }} url : docker.pkg.github.com - name : Do something in default container's workspace run : | sudo cp -R /home/runner/work/_temp/_github_home/.docker ~ sudo chown -R $(whoami) ~/.docker docker pull docker.pkg.github.com/swaglive/dockerfiles/kubectl:1.17 Cache node_modules \u00b6 - uses : actions/cache@v1 with : path : ./node_modules key : ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }} restore-keys : | ${{ runner.os }}-yarn- Fetch private submodule \u00b6 PAT = private access token - name : Fix submodules run : echo -e '[url \"https://github.com/\"]\\n insteadOf = \"git@github.com:\"' >> ~/.gitconfig - name : Checkout uses : actions/checkout@v1 with : fetch-depth : 0 submodules : true token : ${{ secrets.PAT }} Create pull request \u00b6 - name : Create Pull Request if : steps.create-branch.outputs.branch_name uses : actions/github-script@0.3.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | github.pulls.create({ owner: 'swaglive', repo: 'action-demo', title: '[Action] ${{ steps.create-branch.outputs.branch_name }}', head: '${{ steps.create-branch.outputs.branch_name }}', base: 'master' }) - name : Create Pull Request if : steps.create-branch.outputs.branch_name uses : actions/github-script@0.3.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | github.pulls.create({ ...context.repo, title: '[Action] ${{ steps.create-branch.outputs.branch_name }}', body: 'Create by `${{ github.event.client_payload.actor }}`', head: '${{ steps.create-branch.outputs.branch_name }}', base: 'master' }) Close issue when title contains specific string \u00b6 name : issue-opened on : issues : types : [ opened ] jobs : debug : runs-on : ubuntu-latest if : contains(github.event.issue.title, 'Update APK') steps : - name : Close issue uses : actions/github-script@0.8.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | github.issues.update({ ...context.repo, issue_number: context.issue.number, state: 'closed' }) github.issues.createComment({ ...context.repo, issue_number: context.issue.number, body: 'Close this!' }); Create a comment in pull request \u00b6 - name : Notify Results in Pull Request if : steps.generate-mirror-list.outputs.images uses : actions/github-script@0.3.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} images : ${{ steps.generate-mirror-list.outputs.images }} script : | var body = \"## I mirrored something for you\" process.env.INPUT_IMAGES.split(' ').forEach(function(image){ let [source, target] = image.split('@') body = `${body}\\r\\n- \\`${source}\\` -> \\`${target}\\`` }) github.issues.createComment({ ...context.repo, issue_number: context.payload.number, body: body, }) Deploy mkdocs to gh-pages \u00b6 name : Publish on : push : branches : - master jobs : deploy : name : Deploy docs runs-on : ubuntu-latest steps : - name : Checkout master uses : actions/checkout@v1 - name : Deploy docs uses : mhausenblas/mkdocs-deploy-gh-pages@1.11 env : GITHUB_TOKEN : ${{ secrets.GITHUB_TOKEN }} Get environments in action \u00b6 jobs : show-env : runs-on : ubuntu-latest steps : - run : cat $GITHUB_EVENT_PATH - run : echo ${{ github.event_name }} - run : echo ${{ github.event.action }} - run : env Get other step output as enviroment in github-script \u00b6 jobs : debug : runs-on : ubuntu-latest steps : - id : update run : echo ::set-output name=message::okok - name : js uses : actions/github-script@0.8.0 env : MESSAGE : ${{ steps.update.outputs.message }} with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | var message = process.env.MESSAGE if (message !== undefined){ message == 'in' } else { message == 'else' } console.log(message) Othes \u00b6 iOS App Build \u00b6 Compare: bitrise: 2 vCPU + 4 GB RAM Github Action: 2 vCPU + 7 GB RAM Build status \u00b6 Clickable [ ![Publish](https://github.com/RammusXu/toolkit/workflows/Publish/badge.svg)](https://github.com/RammusXu/toolkit) Unclickable ![Publish](https://github.com/RammusXu/toolkit/workflows/Publish/badge.svg) Clickable: Unclickable: Env Sample \u00b6 2020-03-11 Use a self build action \u00b6 /usr/bin/docker run --name e87b528978e939d04c5cabae17f516da08bb2a_79b912 --label e87b52 --workdir /github/workspace --rm -e INPUT_ARGS -e INPUT_MY_VAR -e INPUT_LOWER_VAR -e INPUT_WHO-TO-GREET -e INPUT_NAME -e HOME -e GITHUB_REF -e GITHUB_SHA -e GITHUB_REPOSITORY -e GITHUB_RUN_ID -e GITHUB_RUN_NUMBER -e GITHUB_ACTOR -e GITHUB_WORKFLOW -e GITHUB_HEAD_REF -e GITHUB_BASE_REF -e GITHUB_EVENT_NAME -e GITHUB_WORKSPACE -e GITHUB_ACTION -e GITHUB_EVENT_PATH -e RUNNER_OS -e RUNNER_TOOL_CACHE -e RUNNER_TEMP -e RUNNER_WORKSPACE -e ACTIONS_RUNTIME_URL -e ACTIONS_RUNTIME_TOKEN -e ACTIONS_CACHE_URL -e GITHUB_ACTIONS = true -v \"/var/run/docker.sock\" : \"/var/run/docker.sock\" -v \"/home/runner/work/_temp/_github_home\" : \"/github/home\" -v \"/home/runner/work/_temp/_github_workflow\" : \"/github/workflow\" -v \"/home/runner/work/action-demo/action-demo\" : \"/github/workspace\" e87b52:8978e939d04c5cabae17f516da08bb2a env 2020-02-25 on a push branch \u00b6 PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin HOSTNAME = 7e68d28ee47e HOME = /github/home GITHUB_REF = refs/heads/show-env GITHUB_REPOSITORY = rammusxu/action-demo GITHUB_RUN_ID = 42801200 GITHUB_RUN_NUMBER = 153 GITHUB_ACTOR = RammusXu RUNNER_TEMP = /home/runner/work/_temp INPUT_ARGS = env ACTIONS_RUNTIME_URL = https://pipelines.actions.githubusercontent.com/PMQIhg54lq7cRaMuQESXLNDyCqKLwtTaQOTGOPlUgbwmwZae5C/ RUNNER_WORKSPACE = /home/runner/work/action-demo GITHUB_ACTIONS = true GITHUB_EVENT_NAME = push GITHUB_WORKFLOW = RammusPush GITHUB_HEAD_REF = GITHUB_BASE_REF = GITHUB_ACTION = alpine GITHUB_EVENT_PATH = /github/workflow/event.json RUNNER_OS = Linux RUNNER_TOOL_CACHE = /opt/hostedtoolcache GITHUB_SHA = 7f4bedfc1262dbb55052aa18ecf9d21388c50526 ACTIONS_RUNTIME_TOKEN = *** GITHUB_WORKSPACE = /github/workspace { \"after\" : \"7f4bedfc1262dbb55052aa18ecf9d21388c50526\" , \"base_ref\" : null , \"before\" : \"0000000000000000000000000000000000000000\" , \"commits\" : [ { \"author\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"committer\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"distinct\" : true , \"id\" : \"7f4bedfc1262dbb55052aa18ecf9d21388c50526\" , \"message\" : \"parallel --help\" , \"timestamp\" : \"2020-02-21T13:36:19+08:00\" , \"tree_id\" : \"f4f9fd21306ee5fb29fab80d373ef55b1852c082\" , \"url\" : \"https://github.com/swaglive/action-demo/commit/7f4bedfc1262dbb55052aa18ecf9d21388c50526\" } ], \"compare\" : \"https://github.com/swaglive/action-demo/commit/7f4bedfc1262\" , \"created\" : true , \"deleted\" : false , \"forced\" : false , \"head_commit\" : { \"author\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"committer\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"distinct\" : true , \"id\" : \"7f4bedfc1262dbb55052aa18ecf9d21388c50526\" , \"message\" : \"parallel --help\" , \"timestamp\" : \"2020-02-21T13:36:19+08:00\" , \"tree_id\" : \"f4f9fd21306ee5fb29fab80d373ef55b1852c082\" , \"url\" : \"https://github.com/swaglive/action-demo/commit/7f4bedfc1262dbb55052aa18ecf9d21388c50526\" }, \"organization\" : { \"avatar_url\" : \"https://avatars3.githubusercontent.com/u/36289044?v=4\" , \"description\" : \"The SWAG Life\" , \"events_url\" : \"https://api.github.com/orgs/swaglive/events\" , \"hooks_url\" : \"https://api.github.com/orgs/swaglive/hooks\" , \"id\" : 36289044 , \"issues_url\" : \"https://api.github.com/orgs/swaglive/issues\" , \"login\" : \"swaglive\" , \"members_url\" : \"https://api.github.com/orgs/swaglive/members{/member}\" , \"node_id\" : \"MDEyOk9yZ2FuaXphdGlvbjM2Mjg5MDQ0\" , \"public_members_url\" : \"https://api.github.com/orgs/swaglive/public_members{/member}\" , \"repos_url\" : \"https://api.github.com/orgs/swaglive/repos\" , \"url\" : \"https://api.github.com/orgs/swaglive\" }, \"pusher\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"RammusXu\" }, \"ref\" : \"refs/heads/show-parallel\" , \"repository\" : { \"archive_url\" : \"https://api.github.com/repos/swaglive/action-demo/{archive_format}{/ref}\" , \"archived\" : false , \"assignees_url\" : \"https://api.github.com/repos/swaglive/action-demo/assignees{/user}\" , \"blobs_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/blobs{/sha}\" , \"branches_url\" : \"https://api.github.com/repos/swaglive/action-demo/branches{/branch}\" , \"clone_url\" : \"https://github.com/swaglive/action-demo.git\" , \"collaborators_url\" : \"https://api.github.com/repos/swaglive/action-demo/collaborators{/collaborator}\" , \"comments_url\" : \"https://api.github.com/repos/swaglive/action-demo/comments{/number}\" , \"commits_url\" : \"https://api.github.com/repos/swaglive/action-demo/commits{/sha}\" , \"compare_url\" : \"https://api.github.com/repos/swaglive/action-demo/compare/{base}...{head}\" , \"contents_url\" : \"https://api.github.com/repos/swaglive/action-demo/contents/{+path}\" , \"contributors_url\" : \"https://api.github.com/repos/swaglive/action-demo/contributors\" , \"created_at\" : 1564547431 , \"default_branch\" : \"master\" , \"deployments_url\" : \"https://api.github.com/repos/swaglive/action-demo/deployments\" , \"description\" : null , \"disabled\" : false , \"downloads_url\" : \"https://api.github.com/repos/swaglive/action-demo/downloads\" , \"events_url\" : \"https://api.github.com/repos/swaglive/action-demo/events\" , \"fork\" : false , \"forks\" : 0 , \"forks_count\" : 0 , \"forks_url\" : \"https://api.github.com/repos/swaglive/action-demo/forks\" , \"full_name\" : \"swaglive/action-demo\" , \"git_commits_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/commits{/sha}\" , \"git_refs_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/refs{/sha}\" , \"git_tags_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/tags{/sha}\" , \"git_url\" : \"git://github.com/swaglive/action-demo.git\" , \"has_downloads\" : true , \"has_issues\" : true , \"has_pages\" : false , \"has_projects\" : true , \"has_wiki\" : true , \"homepage\" : null , \"hooks_url\" : \"https://api.github.com/repos/swaglive/action-demo/hooks\" , \"html_url\" : \"https://github.com/swaglive/action-demo\" , \"id\" : 199778774 , \"issue_comment_url\" : \"https://api.github.com/repos/swaglive/action-demo/issues/comments{/number}\" , \"issue_events_url\" : \"https://api.github.com/repos/swaglive/action-demo/issues/events{/number}\" , \"issues_url\" : \"https://api.github.com/repos/swaglive/action-demo/issues{/number}\" , \"keys_url\" : \"https://api.github.com/repos/swaglive/action-demo/keys{/key_id}\" , \"labels_url\" : \"https://api.github.com/repos/swaglive/action-demo/labels{/name}\" , \"language\" : \"Dockerfile\" , \"languages_url\" : \"https://api.github.com/repos/swaglive/action-demo/languages\" , \"license\" : null , \"master_branch\" : \"master\" , \"merges_url\" : \"https://api.github.com/repos/swaglive/action-demo/merges\" , \"milestones_url\" : \"https://api.github.com/repos/swaglive/action-demo/milestones{/number}\" , \"mirror_url\" : null , \"name\" : \"action-demo\" , \"node_id\" : \"MDEwOlJlcG9zaXRvcnkxOTk3Nzg3NzQ=\" , \"notifications_url\" : \"https://api.github.com/repos/swaglive/action-demo/notifications{?since,all,participating}\" , \"open_issues\" : 4 , \"open_issues_count\" : 4 , \"organization\" : \"swaglive\" , \"owner\" : { \"avatar_url\" : \"https://avatars3.githubusercontent.com/u/36289044?v=4\" , \"email\" : \"engineering@swag.live\" , \"events_url\" : \"https://api.github.com/users/swaglive/events{/privacy}\" , \"followers_url\" : \"https://api.github.com/users/swaglive/followers\" , \"following_url\" : \"https://api.github.com/users/swaglive/following{/other_user}\" , \"gists_url\" : \"https://api.github.com/users/swaglive/gists{/gist_id}\" , \"gravatar_id\" : \"\" , \"html_url\" : \"https://github.com/swaglive\" , \"id\" : 36289044 , \"login\" : \"swaglive\" , \"name\" : \"swaglive\" , \"node_id\" : \"MDEyOk9yZ2FuaXphdGlvbjM2Mjg5MDQ0\" , \"organizations_url\" : \"https://api.github.com/users/swaglive/orgs\" , \"received_events_url\" : \"https://api.github.com/users/swaglive/received_events\" , \"repos_url\" : \"https://api.github.com/users/swaglive/repos\" , \"site_admin\" : false , \"starred_url\" : \"https://api.github.com/users/swaglive/starred{/owner}{/repo}\" , \"subscriptions_url\" : \"https://api.github.com/users/swaglive/subscriptions\" , \"type\" : \"Organization\" , \"url\" : \"https://api.github.com/users/swaglive\" }, \"private\" : false , \"pulls_url\" : \"https://api.github.com/repos/swaglive/action-demo/pulls{/number}\" , \"pushed_at\" : 1582263389 , \"releases_url\" : \"https://api.github.com/repos/swaglive/action-demo/releases{/id}\" , \"size\" : 184 , \"ssh_url\" : \"git@github.com:swaglive/action-demo.git\" , \"stargazers\" : 0 , \"stargazers_count\" : 0 , \"stargazers_url\" : \"https://api.github.com/repos/swaglive/action-demo/stargazers\" , \"statuses_url\" : \"https://api.github.com/repos/swaglive/action-demo/statuses/{sha}\" , \"subscribers_url\" : \"https://api.github.com/repos/swaglive/action-demo/subscribers\" , \"subscription_url\" : \"https://api.github.com/repos/swaglive/action-demo/subscription\" , \"svn_url\" : \"https://github.com/swaglive/action-demo\" , \"tags_url\" : \"https://api.github.com/repos/swaglive/action-demo/tags\" , \"teams_url\" : \"https://api.github.com/repos/swaglive/action-demo/teams\" , \"trees_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/trees{/sha}\" , \"updated_at\" : \"2020-02-15T04:12:28Z\" , \"url\" : \"https://github.com/swaglive/action-demo\" , \"watchers\" : 0 , \"watchers_count\" : 0 }, \"sender\" : { \"avatar_url\" : \"https://avatars1.githubusercontent.com/u/4367069?v=4\" , \"events_url\" : \"https://api.github.com/users/RammusXu/events{/privacy}\" , \"followers_url\" : \"https://api.github.com/users/RammusXu/followers\" , \"following_url\" : \"https://api.github.com/users/RammusXu/following{/other_user}\" , \"gists_url\" : \"https://api.github.com/users/RammusXu/gists{/gist_id}\" , \"gravatar_id\" : \"\" , \"html_url\" : \"https://github.com/RammusXu\" , \"id\" : 4367069 , \"login\" : \"RammusXu\" , \"node_id\" : \"MDQ6VXNlcjQzNjcwNjk=\" , \"organizations_url\" : \"https://api.github.com/users/RammusXu/orgs\" , \"received_events_url\" : \"https://api.github.com/users/RammusXu/received_events\" , \"repos_url\" : \"https://api.github.com/users/RammusXu/repos\" , \"site_admin\" : false , \"starred_url\" : \"https://api.github.com/users/RammusXu/starred{/owner}{/repo}\" , \"subscriptions_url\" : \"https://api.github.com/users/RammusXu/subscriptions\" , \"type\" : \"User\" , \"url\" : \"https://api.github.com/users/RammusXu\" } } Reference \u00b6 https://help.github.com/en/actions/reference https://github.com/actions/toolkit/tree/master/packages/github https://github.com/actions/github-script https://octokit.github.io/rest.js/#usage","title":"Github Action"},{"location":"snippets/github-action/#github-action","text":"Github Actions(CI/CD) tricks that official documents didn't mention. This post including hints, tips, snippet, cheatsheet, troubleshooting, notes, how-to.","title":"Github Action"},{"location":"snippets/github-action/#starter","text":"on : push : jobs : test : runs-on : ubuntu-latest steps : - uses : actions/checkout@v2 - name : Run tests run : | echo hi","title":"Starter"},{"location":"snippets/github-action/#on-trigger-event","text":"on : push : branches : - \"master\" - \"**\" tags : - \"**\" pull_request : branches : - master repository_dispatch : types : [ rammus_post ] Important pull_request.branches is base on ref , not head_ref","title":"On trigger event"},{"location":"snippets/github-action/#environments-and-variables","text":"","title":"Environments and variables"},{"location":"snippets/github-action/#pass-variables","text":"echo ::set-output name = message:: $output_message echo ::set-env name = action_state::yellow","title":"Pass variables"},{"location":"snippets/github-action/#use-variables","text":"GITHUB_TOKEN : ${{ secrets.GITHUB_TOKEN }} PR_COMMENT_URL : ${{ github.event.pull_request.comments_url }} PR_COMMENT : ${{ steps.message.outputs.message }} PAYLOAD_ACTOR : ${{ github.event.client_payload.actor }}","title":"Use variables"},{"location":"snippets/github-action/#use-github_actor-as-git-commit-author-and-using-github-avator","text":"https://help.github.com/en/github/setting-up-and-managing-your-github-user-account/setting-your-commit-email-address git config --global user.name \"${GITHUB_ACTOR}\" git config --global user.email \"${GITHUB_ACTOR}@users.noreply.github.com\" remote_repo=\"https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git\" git remote add origin \"${remote_repo}\"","title":"Use GITHUB_ACTOR as git commit author and using github avator"},{"location":"snippets/github-action/#get-commit-author-information","text":"This is only for push event AUTHOR_NAME : ${{ github.event.head_commit.author.name }} AUTHOR_EMAIL : ${{ github.event.head_commit.author.email }}","title":"Get commit author information"},{"location":"snippets/github-action/#if-condition","text":"if : contains(github.ref, 'tags') if : steps.git-diff.outputs.is-diff if : steps.set-env.outputs.message == 'hello' if : github.ref != 'refs/heads/master'","title":"if condition"},{"location":"snippets/github-action/#pull_request","text":"","title":"pull_request"},{"location":"snippets/github-action/#when-specific-event-type","text":"if : github.event_name == 'pull_request' && github.event.action == 'unassigned'","title":"when specific event type"},{"location":"snippets/github-action/#when-branch-name-is","text":"if : github.event_name == 'pull_request' && contains(github.head_ref, 'my-feature-branch')","title":"when branch name is"},{"location":"snippets/github-action/#when-merged","text":"on : pull_request : types : [ closed ] jobs : merged : if : github.event.pull_request.merged == true","title":"when merged"},{"location":"snippets/github-action/#setting","text":"ACTIONS_RUNNER_DEBUG : true","title":"Setting"},{"location":"snippets/github-action/#build-an-action","text":"# action.yml name : 'Hello World' description : 'Greet someone and record the time' inputs : who-to-greet : # id of input description : 'Who to greet' required : true default : 'World' outputs : time : # id of output description : 'The time we greeted you' runs : using : 'docker' image : 'Dockerfile' args : - ${{ inputs.who-to-greet }}","title":"Build an action"},{"location":"snippets/github-action/#get-input-as-environemnt-in-docker","text":"# action.yaml inputs : who-to-greet : # workflow.yaml - uses : ./actions/my-action with : who-to-greet : rammus # entrypoint.sh echo INPUTS_WHO_TO_GREET","title":"Get input as environemnt in Docker"},{"location":"snippets/github-action/#entrypoint-need-to-be-abolute-path","text":"Warning When uses: ./actions/my-action Workflow will mount workspace --workdir /github/workspace COPY ./app.py / ENTRYPOINT python /app.py","title":"ENTRYPOINT need to be abolute path"},{"location":"snippets/github-action/#awesome-actions","text":"","title":"Awesome Actions"},{"location":"snippets/github-action/#customize-action-type-with-http-post-method","text":"on : repository_dispatch : types : [ rammus_post ] jobs : rammus_job : env : ACTOR : ${{ github.event.client_payload.actor }} if : github.event.action == 'rammus_post' And you can send a post request like: INPUT_GITHUB_TOKEN = INPUT_COMMENT_URL = \"https://api.github.com/repos/<owner>/<repo>/dispatches\" curl -H \"Authorization: token $INPUT_GITHUB_TOKEN \" \\ -H \"Accept: application/vnd.github.everest-preview+json\" \\ -d '{\"event_type\":\"rammus_post\",\"client_payload\":{\"new_version_image\":\"echo-server:96b2166\", \"new_version_sha\":\"96b2166\",\"actor\":\"Rammus Xu\"}}' \\ -XPOST $INPUT_COMMENT_URL","title":"Customize action type with http post method"},{"location":"snippets/github-action/#docker-login","text":"- name : Docker Login - docker.pkg.github.com uses : swaglive/actions/docker/login@944b742 with : password : ${{ secrets.GHR_PASSWORD }} username : ${{ secrets.GHR_USERNAME }} url : docker.pkg.github.com - name : Docker Login - docker.pkg.github.com if : contains(github.ref, 'tags') env : DOCKER_PASSWORD : ${{ secrets.GITHUB_TOKEN }} run : echo $DOCKER_PASSWORD | docker login -u $GITHUB_ACTOR --password-stdin docker.pkg.github.com","title":"Docker login"},{"location":"snippets/github-action/#docker-login-and-copy-config-to-default-containers-workspace","text":"Note github runner will mount /home/runner/work/_temp/_github_home\":\"/github/home when we use a docker action. That means we can't use the credential directly in next steps. Only if you use a docker contain step. Since id: generate-mirror-list need docker credentials and run on default container, credentials should be copied to default container's home. And a docker action must run as root. Therefore, it needs to be sudo in a default container. - name : Docker Login - docker.pkg.github.com uses : swaglive/actions/docker/login@944b742 with : password : ${{ secrets.GHR_PASSWORD }} username : ${{ secrets.GHR_USERNAME }} url : docker.pkg.github.com - name : Do something in default container's workspace run : | sudo cp -R /home/runner/work/_temp/_github_home/.docker ~ sudo chown -R $(whoami) ~/.docker docker pull docker.pkg.github.com/swaglive/dockerfiles/kubectl:1.17","title":"Docker login and copy config to default container's workspace"},{"location":"snippets/github-action/#cache-node_modules","text":"- uses : actions/cache@v1 with : path : ./node_modules key : ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }} restore-keys : | ${{ runner.os }}-yarn-","title":"Cache node_modules"},{"location":"snippets/github-action/#fetch-private-submodule","text":"PAT = private access token - name : Fix submodules run : echo -e '[url \"https://github.com/\"]\\n insteadOf = \"git@github.com:\"' >> ~/.gitconfig - name : Checkout uses : actions/checkout@v1 with : fetch-depth : 0 submodules : true token : ${{ secrets.PAT }}","title":"Fetch private submodule"},{"location":"snippets/github-action/#create-pull-request","text":"- name : Create Pull Request if : steps.create-branch.outputs.branch_name uses : actions/github-script@0.3.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | github.pulls.create({ owner: 'swaglive', repo: 'action-demo', title: '[Action] ${{ steps.create-branch.outputs.branch_name }}', head: '${{ steps.create-branch.outputs.branch_name }}', base: 'master' }) - name : Create Pull Request if : steps.create-branch.outputs.branch_name uses : actions/github-script@0.3.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | github.pulls.create({ ...context.repo, title: '[Action] ${{ steps.create-branch.outputs.branch_name }}', body: 'Create by `${{ github.event.client_payload.actor }}`', head: '${{ steps.create-branch.outputs.branch_name }}', base: 'master' })","title":"Create pull request"},{"location":"snippets/github-action/#close-issue-when-title-contains-specific-string","text":"name : issue-opened on : issues : types : [ opened ] jobs : debug : runs-on : ubuntu-latest if : contains(github.event.issue.title, 'Update APK') steps : - name : Close issue uses : actions/github-script@0.8.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | github.issues.update({ ...context.repo, issue_number: context.issue.number, state: 'closed' }) github.issues.createComment({ ...context.repo, issue_number: context.issue.number, body: 'Close this!' });","title":"Close issue when title contains specific string"},{"location":"snippets/github-action/#create-a-comment-in-pull-request","text":"- name : Notify Results in Pull Request if : steps.generate-mirror-list.outputs.images uses : actions/github-script@0.3.0 with : github-token : ${{ secrets.GITHUB_TOKEN }} images : ${{ steps.generate-mirror-list.outputs.images }} script : | var body = \"## I mirrored something for you\" process.env.INPUT_IMAGES.split(' ').forEach(function(image){ let [source, target] = image.split('@') body = `${body}\\r\\n- \\`${source}\\` -> \\`${target}\\`` }) github.issues.createComment({ ...context.repo, issue_number: context.payload.number, body: body, })","title":"Create a comment in pull request"},{"location":"snippets/github-action/#deploy-mkdocs-to-gh-pages","text":"name : Publish on : push : branches : - master jobs : deploy : name : Deploy docs runs-on : ubuntu-latest steps : - name : Checkout master uses : actions/checkout@v1 - name : Deploy docs uses : mhausenblas/mkdocs-deploy-gh-pages@1.11 env : GITHUB_TOKEN : ${{ secrets.GITHUB_TOKEN }}","title":"Deploy mkdocs to gh-pages"},{"location":"snippets/github-action/#get-environments-in-action","text":"jobs : show-env : runs-on : ubuntu-latest steps : - run : cat $GITHUB_EVENT_PATH - run : echo ${{ github.event_name }} - run : echo ${{ github.event.action }} - run : env","title":"Get environments in action"},{"location":"snippets/github-action/#get-other-step-output-as-enviroment-in-github-script","text":"jobs : debug : runs-on : ubuntu-latest steps : - id : update run : echo ::set-output name=message::okok - name : js uses : actions/github-script@0.8.0 env : MESSAGE : ${{ steps.update.outputs.message }} with : github-token : ${{ secrets.GITHUB_TOKEN }} script : | var message = process.env.MESSAGE if (message !== undefined){ message == 'in' } else { message == 'else' } console.log(message)","title":"Get other step output as enviroment in github-script"},{"location":"snippets/github-action/#othes","text":"","title":"Othes"},{"location":"snippets/github-action/#ios-app-build","text":"Compare: bitrise: 2 vCPU + 4 GB RAM Github Action: 2 vCPU + 7 GB RAM","title":"iOS App Build"},{"location":"snippets/github-action/#build-status","text":"Clickable [ ![Publish](https://github.com/RammusXu/toolkit/workflows/Publish/badge.svg)](https://github.com/RammusXu/toolkit) Unclickable ![Publish](https://github.com/RammusXu/toolkit/workflows/Publish/badge.svg) Clickable: Unclickable:","title":"Build status"},{"location":"snippets/github-action/#env-sample","text":"","title":"Env Sample"},{"location":"snippets/github-action/#2020-03-11-use-a-self-build-action","text":"/usr/bin/docker run --name e87b528978e939d04c5cabae17f516da08bb2a_79b912 --label e87b52 --workdir /github/workspace --rm -e INPUT_ARGS -e INPUT_MY_VAR -e INPUT_LOWER_VAR -e INPUT_WHO-TO-GREET -e INPUT_NAME -e HOME -e GITHUB_REF -e GITHUB_SHA -e GITHUB_REPOSITORY -e GITHUB_RUN_ID -e GITHUB_RUN_NUMBER -e GITHUB_ACTOR -e GITHUB_WORKFLOW -e GITHUB_HEAD_REF -e GITHUB_BASE_REF -e GITHUB_EVENT_NAME -e GITHUB_WORKSPACE -e GITHUB_ACTION -e GITHUB_EVENT_PATH -e RUNNER_OS -e RUNNER_TOOL_CACHE -e RUNNER_TEMP -e RUNNER_WORKSPACE -e ACTIONS_RUNTIME_URL -e ACTIONS_RUNTIME_TOKEN -e ACTIONS_CACHE_URL -e GITHUB_ACTIONS = true -v \"/var/run/docker.sock\" : \"/var/run/docker.sock\" -v \"/home/runner/work/_temp/_github_home\" : \"/github/home\" -v \"/home/runner/work/_temp/_github_workflow\" : \"/github/workflow\" -v \"/home/runner/work/action-demo/action-demo\" : \"/github/workspace\" e87b52:8978e939d04c5cabae17f516da08bb2a env","title":"2020-03-11 Use a self build action"},{"location":"snippets/github-action/#2020-02-25-on-a-push-branch","text":"PATH = /usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin HOSTNAME = 7e68d28ee47e HOME = /github/home GITHUB_REF = refs/heads/show-env GITHUB_REPOSITORY = rammusxu/action-demo GITHUB_RUN_ID = 42801200 GITHUB_RUN_NUMBER = 153 GITHUB_ACTOR = RammusXu RUNNER_TEMP = /home/runner/work/_temp INPUT_ARGS = env ACTIONS_RUNTIME_URL = https://pipelines.actions.githubusercontent.com/PMQIhg54lq7cRaMuQESXLNDyCqKLwtTaQOTGOPlUgbwmwZae5C/ RUNNER_WORKSPACE = /home/runner/work/action-demo GITHUB_ACTIONS = true GITHUB_EVENT_NAME = push GITHUB_WORKFLOW = RammusPush GITHUB_HEAD_REF = GITHUB_BASE_REF = GITHUB_ACTION = alpine GITHUB_EVENT_PATH = /github/workflow/event.json RUNNER_OS = Linux RUNNER_TOOL_CACHE = /opt/hostedtoolcache GITHUB_SHA = 7f4bedfc1262dbb55052aa18ecf9d21388c50526 ACTIONS_RUNTIME_TOKEN = *** GITHUB_WORKSPACE = /github/workspace { \"after\" : \"7f4bedfc1262dbb55052aa18ecf9d21388c50526\" , \"base_ref\" : null , \"before\" : \"0000000000000000000000000000000000000000\" , \"commits\" : [ { \"author\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"committer\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"distinct\" : true , \"id\" : \"7f4bedfc1262dbb55052aa18ecf9d21388c50526\" , \"message\" : \"parallel --help\" , \"timestamp\" : \"2020-02-21T13:36:19+08:00\" , \"tree_id\" : \"f4f9fd21306ee5fb29fab80d373ef55b1852c082\" , \"url\" : \"https://github.com/swaglive/action-demo/commit/7f4bedfc1262dbb55052aa18ecf9d21388c50526\" } ], \"compare\" : \"https://github.com/swaglive/action-demo/commit/7f4bedfc1262\" , \"created\" : true , \"deleted\" : false , \"forced\" : false , \"head_commit\" : { \"author\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"committer\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"Rammus Xu\" , \"username\" : \"RammusXu\" }, \"distinct\" : true , \"id\" : \"7f4bedfc1262dbb55052aa18ecf9d21388c50526\" , \"message\" : \"parallel --help\" , \"timestamp\" : \"2020-02-21T13:36:19+08:00\" , \"tree_id\" : \"f4f9fd21306ee5fb29fab80d373ef55b1852c082\" , \"url\" : \"https://github.com/swaglive/action-demo/commit/7f4bedfc1262dbb55052aa18ecf9d21388c50526\" }, \"organization\" : { \"avatar_url\" : \"https://avatars3.githubusercontent.com/u/36289044?v=4\" , \"description\" : \"The SWAG Life\" , \"events_url\" : \"https://api.github.com/orgs/swaglive/events\" , \"hooks_url\" : \"https://api.github.com/orgs/swaglive/hooks\" , \"id\" : 36289044 , \"issues_url\" : \"https://api.github.com/orgs/swaglive/issues\" , \"login\" : \"swaglive\" , \"members_url\" : \"https://api.github.com/orgs/swaglive/members{/member}\" , \"node_id\" : \"MDEyOk9yZ2FuaXphdGlvbjM2Mjg5MDQ0\" , \"public_members_url\" : \"https://api.github.com/orgs/swaglive/public_members{/member}\" , \"repos_url\" : \"https://api.github.com/orgs/swaglive/repos\" , \"url\" : \"https://api.github.com/orgs/swaglive\" }, \"pusher\" : { \"email\" : \"comte_ken@hotmail.com\" , \"name\" : \"RammusXu\" }, \"ref\" : \"refs/heads/show-parallel\" , \"repository\" : { \"archive_url\" : \"https://api.github.com/repos/swaglive/action-demo/{archive_format}{/ref}\" , \"archived\" : false , \"assignees_url\" : \"https://api.github.com/repos/swaglive/action-demo/assignees{/user}\" , \"blobs_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/blobs{/sha}\" , \"branches_url\" : \"https://api.github.com/repos/swaglive/action-demo/branches{/branch}\" , \"clone_url\" : \"https://github.com/swaglive/action-demo.git\" , \"collaborators_url\" : \"https://api.github.com/repos/swaglive/action-demo/collaborators{/collaborator}\" , \"comments_url\" : \"https://api.github.com/repos/swaglive/action-demo/comments{/number}\" , \"commits_url\" : \"https://api.github.com/repos/swaglive/action-demo/commits{/sha}\" , \"compare_url\" : \"https://api.github.com/repos/swaglive/action-demo/compare/{base}...{head}\" , \"contents_url\" : \"https://api.github.com/repos/swaglive/action-demo/contents/{+path}\" , \"contributors_url\" : \"https://api.github.com/repos/swaglive/action-demo/contributors\" , \"created_at\" : 1564547431 , \"default_branch\" : \"master\" , \"deployments_url\" : \"https://api.github.com/repos/swaglive/action-demo/deployments\" , \"description\" : null , \"disabled\" : false , \"downloads_url\" : \"https://api.github.com/repos/swaglive/action-demo/downloads\" , \"events_url\" : \"https://api.github.com/repos/swaglive/action-demo/events\" , \"fork\" : false , \"forks\" : 0 , \"forks_count\" : 0 , \"forks_url\" : \"https://api.github.com/repos/swaglive/action-demo/forks\" , \"full_name\" : \"swaglive/action-demo\" , \"git_commits_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/commits{/sha}\" , \"git_refs_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/refs{/sha}\" , \"git_tags_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/tags{/sha}\" , \"git_url\" : \"git://github.com/swaglive/action-demo.git\" , \"has_downloads\" : true , \"has_issues\" : true , \"has_pages\" : false , \"has_projects\" : true , \"has_wiki\" : true , \"homepage\" : null , \"hooks_url\" : \"https://api.github.com/repos/swaglive/action-demo/hooks\" , \"html_url\" : \"https://github.com/swaglive/action-demo\" , \"id\" : 199778774 , \"issue_comment_url\" : \"https://api.github.com/repos/swaglive/action-demo/issues/comments{/number}\" , \"issue_events_url\" : \"https://api.github.com/repos/swaglive/action-demo/issues/events{/number}\" , \"issues_url\" : \"https://api.github.com/repos/swaglive/action-demo/issues{/number}\" , \"keys_url\" : \"https://api.github.com/repos/swaglive/action-demo/keys{/key_id}\" , \"labels_url\" : \"https://api.github.com/repos/swaglive/action-demo/labels{/name}\" , \"language\" : \"Dockerfile\" , \"languages_url\" : \"https://api.github.com/repos/swaglive/action-demo/languages\" , \"license\" : null , \"master_branch\" : \"master\" , \"merges_url\" : \"https://api.github.com/repos/swaglive/action-demo/merges\" , \"milestones_url\" : \"https://api.github.com/repos/swaglive/action-demo/milestones{/number}\" , \"mirror_url\" : null , \"name\" : \"action-demo\" , \"node_id\" : \"MDEwOlJlcG9zaXRvcnkxOTk3Nzg3NzQ=\" , \"notifications_url\" : \"https://api.github.com/repos/swaglive/action-demo/notifications{?since,all,participating}\" , \"open_issues\" : 4 , \"open_issues_count\" : 4 , \"organization\" : \"swaglive\" , \"owner\" : { \"avatar_url\" : \"https://avatars3.githubusercontent.com/u/36289044?v=4\" , \"email\" : \"engineering@swag.live\" , \"events_url\" : \"https://api.github.com/users/swaglive/events{/privacy}\" , \"followers_url\" : \"https://api.github.com/users/swaglive/followers\" , \"following_url\" : \"https://api.github.com/users/swaglive/following{/other_user}\" , \"gists_url\" : \"https://api.github.com/users/swaglive/gists{/gist_id}\" , \"gravatar_id\" : \"\" , \"html_url\" : \"https://github.com/swaglive\" , \"id\" : 36289044 , \"login\" : \"swaglive\" , \"name\" : \"swaglive\" , \"node_id\" : \"MDEyOk9yZ2FuaXphdGlvbjM2Mjg5MDQ0\" , \"organizations_url\" : \"https://api.github.com/users/swaglive/orgs\" , \"received_events_url\" : \"https://api.github.com/users/swaglive/received_events\" , \"repos_url\" : \"https://api.github.com/users/swaglive/repos\" , \"site_admin\" : false , \"starred_url\" : \"https://api.github.com/users/swaglive/starred{/owner}{/repo}\" , \"subscriptions_url\" : \"https://api.github.com/users/swaglive/subscriptions\" , \"type\" : \"Organization\" , \"url\" : \"https://api.github.com/users/swaglive\" }, \"private\" : false , \"pulls_url\" : \"https://api.github.com/repos/swaglive/action-demo/pulls{/number}\" , \"pushed_at\" : 1582263389 , \"releases_url\" : \"https://api.github.com/repos/swaglive/action-demo/releases{/id}\" , \"size\" : 184 , \"ssh_url\" : \"git@github.com:swaglive/action-demo.git\" , \"stargazers\" : 0 , \"stargazers_count\" : 0 , \"stargazers_url\" : \"https://api.github.com/repos/swaglive/action-demo/stargazers\" , \"statuses_url\" : \"https://api.github.com/repos/swaglive/action-demo/statuses/{sha}\" , \"subscribers_url\" : \"https://api.github.com/repos/swaglive/action-demo/subscribers\" , \"subscription_url\" : \"https://api.github.com/repos/swaglive/action-demo/subscription\" , \"svn_url\" : \"https://github.com/swaglive/action-demo\" , \"tags_url\" : \"https://api.github.com/repos/swaglive/action-demo/tags\" , \"teams_url\" : \"https://api.github.com/repos/swaglive/action-demo/teams\" , \"trees_url\" : \"https://api.github.com/repos/swaglive/action-demo/git/trees{/sha}\" , \"updated_at\" : \"2020-02-15T04:12:28Z\" , \"url\" : \"https://github.com/swaglive/action-demo\" , \"watchers\" : 0 , \"watchers_count\" : 0 }, \"sender\" : { \"avatar_url\" : \"https://avatars1.githubusercontent.com/u/4367069?v=4\" , \"events_url\" : \"https://api.github.com/users/RammusXu/events{/privacy}\" , \"followers_url\" : \"https://api.github.com/users/RammusXu/followers\" , \"following_url\" : \"https://api.github.com/users/RammusXu/following{/other_user}\" , \"gists_url\" : \"https://api.github.com/users/RammusXu/gists{/gist_id}\" , \"gravatar_id\" : \"\" , \"html_url\" : \"https://github.com/RammusXu\" , \"id\" : 4367069 , \"login\" : \"RammusXu\" , \"node_id\" : \"MDQ6VXNlcjQzNjcwNjk=\" , \"organizations_url\" : \"https://api.github.com/users/RammusXu/orgs\" , \"received_events_url\" : \"https://api.github.com/users/RammusXu/received_events\" , \"repos_url\" : \"https://api.github.com/users/RammusXu/repos\" , \"site_admin\" : false , \"starred_url\" : \"https://api.github.com/users/RammusXu/starred{/owner}{/repo}\" , \"subscriptions_url\" : \"https://api.github.com/users/RammusXu/subscriptions\" , \"type\" : \"User\" , \"url\" : \"https://api.github.com/users/RammusXu\" } }","title":"2020-02-25 on a push branch"},{"location":"snippets/github-action/#reference","text":"https://help.github.com/en/actions/reference https://github.com/actions/toolkit/tree/master/packages/github https://github.com/actions/github-script https://octokit.github.io/rest.js/#usage","title":"Reference"},{"location":"snippets/gitlabci/","text":"Gitlab CI \u00b6 Debugging Containers \u00b6 For Gitlab CI docker run -it --rm -v $PWD :/app docker:18.09-git sh rammusxu/docker-box:python rammusxu/docker-box:node image : docker:stable services : - docker:dind variables : DOCKER_DRIVER : overlay2 IMAGE_LATEST : $CI_REGISTRY_IMAGE:latest before_script : - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY build : stage : build script : - docker build -t $CI_REGISTRY_IMAGE:master . - docker push $CI_REGISTRY_IMAGE:master Quick build \u00b6 image : docker:18.09-git services : - docker:dind variables : DOCKER_DRIVER : overlay2 build : stage : build script : - docker images - docker build . - docker images","title":"Gitlab CI"},{"location":"snippets/gitlabci/#gitlab-ci","text":"","title":"Gitlab CI"},{"location":"snippets/gitlabci/#debugging-containers","text":"For Gitlab CI docker run -it --rm -v $PWD :/app docker:18.09-git sh rammusxu/docker-box:python rammusxu/docker-box:node image : docker:stable services : - docker:dind variables : DOCKER_DRIVER : overlay2 IMAGE_LATEST : $CI_REGISTRY_IMAGE:latest before_script : - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN $CI_REGISTRY build : stage : build script : - docker build -t $CI_REGISTRY_IMAGE:master . - docker push $CI_REGISTRY_IMAGE:master","title":"Debugging Containers"},{"location":"snippets/gitlabci/#quick-build","text":"image : docker:18.09-git services : - docker:dind variables : DOCKER_DRIVER : overlay2 build : stage : build script : - docker images - docker build . - docker images","title":"Quick build"},{"location":"snippets/jenkins/","text":"curl trigger build \u00b6 curl -i -d \"targetEnv=demo&myArg=helloWorld\" \\ -u admin:a_md5_context \\ -XPOST https://my_domain/job/my_job/buildWithParameters","title":"Jenkins"},{"location":"snippets/jenkins/#curl-trigger-build","text":"curl -i -d \"targetEnv=demo&myArg=helloWorld\" \\ -u admin:a_md5_context \\ -XPOST https://my_domain/job/my_job/buildWithParameters","title":"curl trigger build"},{"location":"snippets/kubernetes/","text":"Volumes \u00b6 spec : template : spec : volumes : - name : plugindir emptyDir : {} containers : - name : mongos image : mongo:4.0.2 volumeMounts : - name : mongo-socket mountPath : /tmp Resources \u00b6 resources : limits : cpu : 1 memory : 2G requests : cpu : 1 memory : 2G PVC \u00b6 apiVersion : v1 kind : PersistentVolumeClaim metadata : name : grafana labels : app : grafana spec : accessModes : - ReadWriteOnce resources : requests : storage : 10Gi storageClassName : standard --- apiVersion : apps/v1 kind : Deployment metadata : name : grafana labels : app : grafana spec : replicas : 1 selector : matchLabels : app : grafana strategy : type : RollingUpdate template : metadata : labels : app : grafana spec : volumes : - name : storage persistentVolumeClaim : claimName : standard # emptyDir: {} Affinity \u00b6 Pod \u53ea\u80fd\u653e\u5728\u7b26\u5408\u4ee5\u4e0b\u689d\u4ef6\u7684 Node \u00b6 spec : affinity : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : cloud.google.com/gke-preemptible operator : NotIn values : - \"true\" - key : sysctl/vm.max_map_count operator : In values : - \"262144\" \u540c\u4e00\u500b Node \u4e0d\u653e\u4e00\u6a23\u7684 Pod \u00b6 spec : affinity : podAntiAffinity : requiredDuringSchedulingIgnoredDuringExecution : - topologyKey : \"kubernetes.io/hostname\" labelSelector : matchExpressions : - key : \"app\" operator : In values : - mongo-sh0 env \u00b6 metadata.annotations \u00b6 template : metadata : annotations : version : abc4444 spec : containers : - name : cronjob env : - name : MY_VERSION valueFrom : fieldRef : fieldPath : metadata.annotations['version'] metadata.name metadata.namespace \u00b6 ref: https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#capabilities-of-the-downward-api env : - name : POD_NAMESPACE valueFrom : fieldRef : fieldPath : metadata.namespace - name : POD_NAME valueFrom : fieldRef : fieldPath : metadata.name Secret \u00b6 Encode/Decode echo -n 'mykey' | base64 echo -n 'bXlrZXk=' | base64 -D apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : mykey : bXlrZXk= spec : containers : - name : mycontainer image : redis env : - name : SECRET_USERNAME valueFrom : secretKeyRef : name : mysecret key : mykey envFrom \u00b6 spec : containers : - name : http image : asia.gcr.io/swag-2c052/swag:42ff66b1 envFrom : - configMapRef : name : myconfigmap - secretRef : name : mysecret volumeMounts from configmap \u00b6 Pod spec : volumes : - name : config configMap : name : nginx-config containers : - name : echoserver image : gcr.io/google_containers/echoserver:1.10 ports : - containerPort : 8080 # nginx.conf override volumeMounts : - name : config subPath : nginx.conf mountPath : /etc/nginx/nginx.conf # mountPath: /usr/local/openresty/nginx/conf/nginx.conf readOnly : true ConfigMap apiVersion : v1 kind : ConfigMap metadata : name : nginx-config namespace : ingress-nginx data : nginx.conf : |- events { worker_connections 1024; } Container Injection \u00b6 /etc/hosts and /etc/resolv.conf \u00b6 ref: https://kubernetes.io/docs/concepts/services-networking/add-entries-to-pod-etc-hosts-with-host-aliases/#adding-additional-entries-with-hostaliases https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-config This will append hostname and overwrite /etc/resolv.conf apiVersion : extensions/v1beta1 kind : Deployment metadata : name : dnsmasq labels : name : dnsmasq spec : strategy : rollingUpdate : maxSurge : 1 maxUnavailable : 1 type : RollingUpdate template : metadata : labels : name : dnsmasq spec : hostAliases : - ip : \"35.227.233.133\" hostnames : - \"swag.live\" dnsPolicy : \"None\" dnsConfig : nameservers : - 1.1.1.1 - 8.8.8.8 containers : - image : rammusxu/dnsmasq name : dnsmasq resources : requests : cpu : \"100m\" memory : \"100M\" ports : - containerPort : 53 name : dnsmasq - containerPort : 53 protocol : UDP name : dnsmasq-udp imagePullPolicy : Always Container with commands \u00b6 - name : imagemagick image : swaglive/imagemagick:lastest command : [ \"/bin/sh\" , \"-c\" ] args : - | magick montage -quality 90 -resize 211x292^ -gravity center -crop 211x292+0+0 -geometry +4+4 -tile 7x4 -background none +repage $(cat /tmp/covers.txt) /tmp/montage.jpg volumeMounts : - name : tmp mountPath : /tmp Frequent Commands \u00b6 Gracefully rolling restart deployment. \u00b6 kubectl rollout restart deployment/my-sites --namespace = default Reference \u00b6 feiskyer Handbook feiskyer Examples","title":"Kubernetes"},{"location":"snippets/kubernetes/#volumes","text":"spec : template : spec : volumes : - name : plugindir emptyDir : {} containers : - name : mongos image : mongo:4.0.2 volumeMounts : - name : mongo-socket mountPath : /tmp","title":"Volumes"},{"location":"snippets/kubernetes/#resources","text":"resources : limits : cpu : 1 memory : 2G requests : cpu : 1 memory : 2G","title":"Resources"},{"location":"snippets/kubernetes/#pvc","text":"apiVersion : v1 kind : PersistentVolumeClaim metadata : name : grafana labels : app : grafana spec : accessModes : - ReadWriteOnce resources : requests : storage : 10Gi storageClassName : standard --- apiVersion : apps/v1 kind : Deployment metadata : name : grafana labels : app : grafana spec : replicas : 1 selector : matchLabels : app : grafana strategy : type : RollingUpdate template : metadata : labels : app : grafana spec : volumes : - name : storage persistentVolumeClaim : claimName : standard # emptyDir: {}","title":"PVC"},{"location":"snippets/kubernetes/#affinity","text":"","title":"Affinity"},{"location":"snippets/kubernetes/#pod-node","text":"spec : affinity : nodeAffinity : requiredDuringSchedulingIgnoredDuringExecution : nodeSelectorTerms : - matchExpressions : - key : cloud.google.com/gke-preemptible operator : NotIn values : - \"true\" - key : sysctl/vm.max_map_count operator : In values : - \"262144\"","title":"Pod \u53ea\u80fd\u653e\u5728\u7b26\u5408\u4ee5\u4e0b\u689d\u4ef6\u7684 Node"},{"location":"snippets/kubernetes/#node-pod","text":"spec : affinity : podAntiAffinity : requiredDuringSchedulingIgnoredDuringExecution : - topologyKey : \"kubernetes.io/hostname\" labelSelector : matchExpressions : - key : \"app\" operator : In values : - mongo-sh0","title":"\u540c\u4e00\u500b Node \u4e0d\u653e\u4e00\u6a23\u7684 Pod"},{"location":"snippets/kubernetes/#env","text":"","title":"env"},{"location":"snippets/kubernetes/#metadataannotations","text":"template : metadata : annotations : version : abc4444 spec : containers : - name : cronjob env : - name : MY_VERSION valueFrom : fieldRef : fieldPath : metadata.annotations['version']","title":"metadata.annotations"},{"location":"snippets/kubernetes/#metadataname-metadatanamespace","text":"ref: https://kubernetes.io/docs/tasks/inject-data-application/downward-api-volume-expose-pod-information/#capabilities-of-the-downward-api env : - name : POD_NAMESPACE valueFrom : fieldRef : fieldPath : metadata.namespace - name : POD_NAME valueFrom : fieldRef : fieldPath : metadata.name","title":"metadata.name metadata.namespace"},{"location":"snippets/kubernetes/#secret","text":"Encode/Decode echo -n 'mykey' | base64 echo -n 'bXlrZXk=' | base64 -D apiVersion : v1 kind : Secret metadata : name : mysecret type : Opaque data : mykey : bXlrZXk= spec : containers : - name : mycontainer image : redis env : - name : SECRET_USERNAME valueFrom : secretKeyRef : name : mysecret key : mykey","title":"Secret"},{"location":"snippets/kubernetes/#envfrom","text":"spec : containers : - name : http image : asia.gcr.io/swag-2c052/swag:42ff66b1 envFrom : - configMapRef : name : myconfigmap - secretRef : name : mysecret","title":"envFrom"},{"location":"snippets/kubernetes/#volumemounts-from-configmap","text":"Pod spec : volumes : - name : config configMap : name : nginx-config containers : - name : echoserver image : gcr.io/google_containers/echoserver:1.10 ports : - containerPort : 8080 # nginx.conf override volumeMounts : - name : config subPath : nginx.conf mountPath : /etc/nginx/nginx.conf # mountPath: /usr/local/openresty/nginx/conf/nginx.conf readOnly : true ConfigMap apiVersion : v1 kind : ConfigMap metadata : name : nginx-config namespace : ingress-nginx data : nginx.conf : |- events { worker_connections 1024; }","title":"volumeMounts from configmap"},{"location":"snippets/kubernetes/#container-injection","text":"","title":"Container Injection"},{"location":"snippets/kubernetes/#etchosts-and-etcresolvconf","text":"ref: https://kubernetes.io/docs/concepts/services-networking/add-entries-to-pod-etc-hosts-with-host-aliases/#adding-additional-entries-with-hostaliases https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/#pod-s-dns-config This will append hostname and overwrite /etc/resolv.conf apiVersion : extensions/v1beta1 kind : Deployment metadata : name : dnsmasq labels : name : dnsmasq spec : strategy : rollingUpdate : maxSurge : 1 maxUnavailable : 1 type : RollingUpdate template : metadata : labels : name : dnsmasq spec : hostAliases : - ip : \"35.227.233.133\" hostnames : - \"swag.live\" dnsPolicy : \"None\" dnsConfig : nameservers : - 1.1.1.1 - 8.8.8.8 containers : - image : rammusxu/dnsmasq name : dnsmasq resources : requests : cpu : \"100m\" memory : \"100M\" ports : - containerPort : 53 name : dnsmasq - containerPort : 53 protocol : UDP name : dnsmasq-udp imagePullPolicy : Always","title":"/etc/hosts and /etc/resolv.conf"},{"location":"snippets/kubernetes/#container-with-commands","text":"- name : imagemagick image : swaglive/imagemagick:lastest command : [ \"/bin/sh\" , \"-c\" ] args : - | magick montage -quality 90 -resize 211x292^ -gravity center -crop 211x292+0+0 -geometry +4+4 -tile 7x4 -background none +repage $(cat /tmp/covers.txt) /tmp/montage.jpg volumeMounts : - name : tmp mountPath : /tmp","title":"Container with commands"},{"location":"snippets/kubernetes/#frequent-commands","text":"","title":"Frequent Commands"},{"location":"snippets/kubernetes/#gracefully-rolling-restart-deployment","text":"kubectl rollout restart deployment/my-sites --namespace = default","title":"Gracefully rolling restart deployment."},{"location":"snippets/kubernetes/#reference","text":"feiskyer Handbook feiskyer Examples","title":"Reference"},{"location":"snippets/linux/","text":"Git \u00b6 git branch - D 20190320 _for_ssl git branch - avv git remote - v git pull --rebase git checkout - t origin / 20190320 _for_ssl git checkout master git push - u origin feature_branch_name git push - u origin HEAD : 20190401 _add_k8s_stage git remote prune origin --dry-run git remote prune origin git submodule update --init Process \u00b6 ps aux | grep \"java -jar build/libs/Hello-1.0.jar\" pgrep - f \"java -jar build/libs/Hello-1.0.jar\" pkill - f \"java -jar build/libs/Hello-1.0.jar\" pgrep - f \"java -jar build/libs/Hello-1.0.jar\" | xargs kill pkill - f \"java -jar build/libs/Hello-1.0.jar\" || true lsof - i : 27017 ps aux | grep node kill - 9 PID killall node Do something parallel \u00b6 \u958b\u591a\u500b thread \u540c\u6642\u57f7\u884c\u591a\u500b\u6307\u4ee4 \u00b6 parallel docker push ::: \\ $DOCKER_REGISTRY_URL / $DOCKER_REPOSITORY_NAME : $DOCKER_REF_TAG -builder \\ $DOCKER_REGISTRY_URL / $DOCKER_REPOSITORY_NAME : $DOCKER_REF_TAG \\ $DOCKER_REGISTRY_URL / $DOCKER_REPOSITORY_NAME : $DOCKER_TAG System config \u00b6 screen ~/ Library / Containers / com . docker . docker / Data / vms / 0 / tty sysctl - w vm . max_map_count = 262144 sysctl - a | grep vm sysctl - a | grep vm . max_map_count sysctl vm . max_map_count Disk, Storage \u00b6 ls -lh file du -sh folder Monitoring \u00b6 Login log \u00b6 last lastlog Keep tracking a command \u00b6 watch -n 1 -d http http://localhost/ Linux User \u00b6 /etc/ssh/sshd_config /etc/passwd /etc/sudoers userdel ashish userdel -r ashish # and Home Directory cp \u00b6 Copy folder content to another folder \u00b6 cp -ar plugins/. share-plugins apt-get \u00b6 # ping apt-get install iputils-ping # dig, nslookup apt-get install dnsutils -y # ps apt-get install procps # mysql apt-get install mysql-client wget, curl \u00b6 # wget -qO- https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-240.0.0-darwin-x86_64.tar.gz | tar xvz - wget -qO- your_link_here | tar xvz - wget -O- https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-240.0.0-darwin-x86_64.tar.gz | tar xvz -C . # wget -O- https://github.com/sing1ee/elasticsearch-jieba-plugin/archive/v7.0.0.tar.gz | tar -xzv -C . --strip 1 wget -O- your_link_here | tar -xzv -C . --strip 1 wget -q -O tmp.zip http://downloads.wordpress.org/plugin/akismet.2.5.3.zip && unzip tmp.zip && rm tmp.zip curl -X GET \"https://httpbin.org/ip\" -H \"accept: application/json\" curl https://httpbin.org/ip curl https://sdk.cloud.google.com | bash -s -- --disable-prompts Get response time \u00b6 curl -o /dev/null -w \"Connect: %{time_connect} TTFB: %{time_starttransfer} Total time: %{time_total} Size: %{size_download} \\n\" https://google.com curl -o /dev/null -s -w 'Total: %{time_total}s\\n' https://www.google.com String(Text) Processing \u00b6 # -P: Perl regex # -o: Only match # \\K: Only match Perl regex will show grep -oP 'foobar \\K\\w+' test.txt # -F: multi delimiter awk -F ' |\\r' '{print $2 \"/cover.jpg\"}' Using variable in xargs \u00b6 # curl is wired. https://stackoverflow.com/questions/37014430/awk-how-to-concat-number-with-strings # -P: multi process # -I: input stream as a variable xargs -P 10 -I username curl -sI https://xxxxxxxxxxx/username | grep 'Location: ' | awk '{print $2 \"/a_string\"}' Get nth line of stdout on linux \u00b6 ref: https://stackoverflow.com/questions/1429556/command-to-get-nth-line-of-stdout ls -l | sed -n 2p ls -l | head -2 | tail -1 Parsing xml in bash \u00b6 apk add libxml2-utils curl curl -s https://data.iana.org/root-anchors/root-anchors.xml | xmllint --format --xpath 'TrustAnchor/KeyDigest/KeyTag' - Load Testing \u00b6 Generate High CPU Usage \u00b6 while true ; do echo \"hi\" ; done ; while true ; do curl localhost ; done ; Generate High memory usage \u00b6 ref: https://stackoverflow.com/questions/20200982/how-to-generate-a-memory-shortage-using-bash-script yes | tr \\\\ n x | head -c $BYTES | grep n yes | tr \\\\ n x | head -c 100m | grep n jq \u00b6 $(msg=$(cat $(grep -E \"(mirror to|replace by)\" *.txt -l)) jq -nc '{\"body\":env.msg}')","title":"Linux"},{"location":"snippets/linux/#git","text":"git branch - D 20190320 _for_ssl git branch - avv git remote - v git pull --rebase git checkout - t origin / 20190320 _for_ssl git checkout master git push - u origin feature_branch_name git push - u origin HEAD : 20190401 _add_k8s_stage git remote prune origin --dry-run git remote prune origin git submodule update --init","title":"Git"},{"location":"snippets/linux/#process","text":"ps aux | grep \"java -jar build/libs/Hello-1.0.jar\" pgrep - f \"java -jar build/libs/Hello-1.0.jar\" pkill - f \"java -jar build/libs/Hello-1.0.jar\" pgrep - f \"java -jar build/libs/Hello-1.0.jar\" | xargs kill pkill - f \"java -jar build/libs/Hello-1.0.jar\" || true lsof - i : 27017 ps aux | grep node kill - 9 PID killall node","title":"Process"},{"location":"snippets/linux/#do-something-parallel","text":"","title":"Do something parallel"},{"location":"snippets/linux/#thread","text":"parallel docker push ::: \\ $DOCKER_REGISTRY_URL / $DOCKER_REPOSITORY_NAME : $DOCKER_REF_TAG -builder \\ $DOCKER_REGISTRY_URL / $DOCKER_REPOSITORY_NAME : $DOCKER_REF_TAG \\ $DOCKER_REGISTRY_URL / $DOCKER_REPOSITORY_NAME : $DOCKER_TAG","title":"\u958b\u591a\u500b thread \u540c\u6642\u57f7\u884c\u591a\u500b\u6307\u4ee4"},{"location":"snippets/linux/#system-config","text":"screen ~/ Library / Containers / com . docker . docker / Data / vms / 0 / tty sysctl - w vm . max_map_count = 262144 sysctl - a | grep vm sysctl - a | grep vm . max_map_count sysctl vm . max_map_count","title":"System config"},{"location":"snippets/linux/#disk-storage","text":"ls -lh file du -sh folder","title":"Disk, Storage"},{"location":"snippets/linux/#monitoring","text":"","title":"Monitoring"},{"location":"snippets/linux/#login-log","text":"last lastlog","title":"Login log"},{"location":"snippets/linux/#keep-tracking-a-command","text":"watch -n 1 -d http http://localhost/","title":"Keep tracking a command"},{"location":"snippets/linux/#linux-user","text":"/etc/ssh/sshd_config /etc/passwd /etc/sudoers userdel ashish userdel -r ashish # and Home Directory","title":"Linux User"},{"location":"snippets/linux/#cp","text":"","title":"cp"},{"location":"snippets/linux/#copy-folder-content-to-another-folder","text":"cp -ar plugins/. share-plugins","title":"Copy folder content to another folder"},{"location":"snippets/linux/#apt-get","text":"# ping apt-get install iputils-ping # dig, nslookup apt-get install dnsutils -y # ps apt-get install procps # mysql apt-get install mysql-client","title":"apt-get"},{"location":"snippets/linux/#wget-curl","text":"# wget -qO- https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-240.0.0-darwin-x86_64.tar.gz | tar xvz - wget -qO- your_link_here | tar xvz - wget -O- https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-240.0.0-darwin-x86_64.tar.gz | tar xvz -C . # wget -O- https://github.com/sing1ee/elasticsearch-jieba-plugin/archive/v7.0.0.tar.gz | tar -xzv -C . --strip 1 wget -O- your_link_here | tar -xzv -C . --strip 1 wget -q -O tmp.zip http://downloads.wordpress.org/plugin/akismet.2.5.3.zip && unzip tmp.zip && rm tmp.zip curl -X GET \"https://httpbin.org/ip\" -H \"accept: application/json\" curl https://httpbin.org/ip curl https://sdk.cloud.google.com | bash -s -- --disable-prompts","title":"wget, curl"},{"location":"snippets/linux/#get-response-time","text":"curl -o /dev/null -w \"Connect: %{time_connect} TTFB: %{time_starttransfer} Total time: %{time_total} Size: %{size_download} \\n\" https://google.com curl -o /dev/null -s -w 'Total: %{time_total}s\\n' https://www.google.com","title":"Get response time"},{"location":"snippets/linux/#stringtext-processing","text":"# -P: Perl regex # -o: Only match # \\K: Only match Perl regex will show grep -oP 'foobar \\K\\w+' test.txt # -F: multi delimiter awk -F ' |\\r' '{print $2 \"/cover.jpg\"}'","title":"String(Text) Processing"},{"location":"snippets/linux/#using-variable-in-xargs","text":"# curl is wired. https://stackoverflow.com/questions/37014430/awk-how-to-concat-number-with-strings # -P: multi process # -I: input stream as a variable xargs -P 10 -I username curl -sI https://xxxxxxxxxxx/username | grep 'Location: ' | awk '{print $2 \"/a_string\"}'","title":"Using variable in xargs"},{"location":"snippets/linux/#get-nth-line-of-stdout-on-linux","text":"ref: https://stackoverflow.com/questions/1429556/command-to-get-nth-line-of-stdout ls -l | sed -n 2p ls -l | head -2 | tail -1","title":"Get nth line of stdout on linux"},{"location":"snippets/linux/#parsing-xml-in-bash","text":"apk add libxml2-utils curl curl -s https://data.iana.org/root-anchors/root-anchors.xml | xmllint --format --xpath 'TrustAnchor/KeyDigest/KeyTag' -","title":"Parsing xml in bash"},{"location":"snippets/linux/#load-testing","text":"","title":"Load Testing"},{"location":"snippets/linux/#generate-high-cpu-usage","text":"while true ; do echo \"hi\" ; done ; while true ; do curl localhost ; done ;","title":"Generate High CPU Usage"},{"location":"snippets/linux/#generate-high-memory-usage","text":"ref: https://stackoverflow.com/questions/20200982/how-to-generate-a-memory-shortage-using-bash-script yes | tr \\\\ n x | head -c $BYTES | grep n yes | tr \\\\ n x | head -c 100m | grep n","title":"Generate High memory usage"},{"location":"snippets/linux/#jq","text":"$(msg=$(cat $(grep -E \"(mirror to|replace by)\" *.txt -l)) jq -nc '{\"body\":env.msg}')","title":"jq"},{"location":"snippets/lua/","text":"for k , v in pairs ( resp_user . header ) do -- ngx.header[k] = v ngx . say ( k .. ' ' .. v ) end","title":"Lua"},{"location":"snippets/mac-setup/","text":"Mac Setup \u00b6 Tool \u00b6 brew \u00b6 Install: /usr/bin/ruby -e \" $( curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install ) \" brew install bash-completion # Then add the following line to your ~/.bash_profile: [ -f /usr/local/etc/bash_completion ] && . /usr/local/etc/bash_completion Must have: brew install python3 brew install pyenv brew upgrade pyenv install 3 .6.8 Terminal \u00b6 brew cask install iterm2 brew install zsh zsh-completions iTerm2 > Preferences > Profiles > Keys https://medium.com/@jonnyhaynes/jump-forwards-backwards-and-delete-a-word-in-iterm2-on-mac-os-43821511f0a \u2325+\u2190 \u2325+\u2192 escape zsh \u00b6 https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins plugins=(git z httpie zsh-autosuggestions) What I use: - https://github.com/zsh-users/zsh-autosuggestions - git z httpie Software \u00b6 source tree vs code docker for desktop Setting \u00b6 Touchpad \u9ede\u4e00\u4e0b\u4f86\u9078\u6309 Sharing Computer name \u8f14\u52a9\u4f7f\u7528 Touchpad touchpad option > \u62d6\u79fb > \u4e09\u6307\u62d6\u79fb Keyboard \u6309\u9375\u91cd\u8907 > \u5feb \u91cd\u8907\u524d\u66ab\u5ef6 > \u77ed \u4f7f\u7528 F1, F2 \u6307\u63ee\u4e2d\u5fc3 \u6839\u64da\u6700\u8fd1\u7684\u4f7f\u7528\u60c5\u6cc1\u91cd\u65b0\u6392\u5217\u7a7a\u9593 > uncheck","title":"Mac Setup"},{"location":"snippets/mac-setup/#mac-setup","text":"","title":"Mac Setup"},{"location":"snippets/mac-setup/#tool","text":"","title":"Tool"},{"location":"snippets/mac-setup/#brew","text":"Install: /usr/bin/ruby -e \" $( curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install ) \" brew install bash-completion # Then add the following line to your ~/.bash_profile: [ -f /usr/local/etc/bash_completion ] && . /usr/local/etc/bash_completion Must have: brew install python3 brew install pyenv brew upgrade pyenv install 3 .6.8","title":"brew"},{"location":"snippets/mac-setup/#terminal","text":"brew cask install iterm2 brew install zsh zsh-completions iTerm2 > Preferences > Profiles > Keys https://medium.com/@jonnyhaynes/jump-forwards-backwards-and-delete-a-word-in-iterm2-on-mac-os-43821511f0a \u2325+\u2190 \u2325+\u2192 escape","title":"Terminal"},{"location":"snippets/mac-setup/#zsh","text":"https://github.com/ohmyzsh/ohmyzsh/wiki/Plugins plugins=(git z httpie zsh-autosuggestions) What I use: - https://github.com/zsh-users/zsh-autosuggestions - git z httpie","title":"zsh"},{"location":"snippets/mac-setup/#software","text":"source tree vs code docker for desktop","title":"Software"},{"location":"snippets/mac-setup/#setting","text":"Touchpad \u9ede\u4e00\u4e0b\u4f86\u9078\u6309 Sharing Computer name \u8f14\u52a9\u4f7f\u7528 Touchpad touchpad option > \u62d6\u79fb > \u4e09\u6307\u62d6\u79fb Keyboard \u6309\u9375\u91cd\u8907 > \u5feb \u91cd\u8907\u524d\u66ab\u5ef6 > \u77ed \u4f7f\u7528 F1, F2 \u6307\u63ee\u4e2d\u5fc3 \u6839\u64da\u6700\u8fd1\u7684\u4f7f\u7528\u60c5\u6cc1\u91cd\u65b0\u6392\u5217\u7a7a\u9593 > uncheck","title":"Setting"},{"location":"snippets/make/","text":"\u4f7f\u7528\u53e6\u4e00\u500b target \u00b6 start : echo this is start use - start : echo this is use - start $ ( MAKE ) start target \u4f9d\u8cf4\u53e6\u4e00\u500b target \u00b6 install : pip install - r requirements . txt start : install mkdocs serve Reference \u00b6 https://devhints.io/makefile","title":"Make"},{"location":"snippets/make/#target","text":"start : echo this is start use - start : echo this is use - start $ ( MAKE ) start","title":"\u4f7f\u7528\u53e6\u4e00\u500b target"},{"location":"snippets/make/#target-target","text":"install : pip install - r requirements . txt start : install mkdocs serve","title":"target \u4f9d\u8cf4\u53e6\u4e00\u500b target"},{"location":"snippets/make/#reference","text":"https://devhints.io/makefile","title":"Reference"},{"location":"snippets/mongo/","text":"Cluster setup \u00b6 rs . initiate ( { _id : \"<replSetName>\" , configsvr : true , members : [ { _id : 0 , host : \"cfg1.example.net:27019\" }, { _id : 1 , host : \"cfg2.example.net:27019\" , priority : 0.5 }, { _id : 2 , host : \"cfg3.example.net:27019\" , priority : 0.5 } ] } ) rs . initiate ( { _id : \"configReplSet\" , configsvr : true , members : [ { _id : 0 , host : \"mongo-configsvr-0.mongo-configsvr:27019\" }, { _id : 1 , host : \"mongo-configsvr-1.mongo-configsvr:27019\" , priority : 0.5 }, { _id : 2 , host : \"mongo-configsvr-2.mongo-configsvr:27019\" , priority : 0.5 } ] } ) rs . initiate ( { _id : \"rs0\" , members : [ { _id : 0 , host : \"mongo-sh0-0.mongo-sh0:27017\" }, { _id : 1 , host : \"mongo-sh0-1.mongo-sh0:27017\" , priority : 0.5 }, { _id : 2 , host : \"mongo-sh0-2.mongo-sh0:27017\" , priority : 0.5 } ] } ) sh . addShard ( \"<replSetName>/s1-mongo1.example.net:27017\" ) sh . addShard ( \"rs0/mongo-sh0-0.mongo-sh0:27017\" ) rs . initiate () rs . status () rs . isMaster () rs . config () sh . status () rs . reconfig ( rs . config (),{ force : true }) mongo -- port 27019 -- eval \"rs.reconfig(rs.config(),{force:true})\" Config \u00b6 db . getMongo (). setReadPref ( 'secondaryPreferred' ) Usage \u00b6 use myNewDatabase db . myCollection . insertOne ( { x : 1 } ) db . myCollection . find () Connection pools db . serverStatus (). connections db . currentOp ( true ) db . runCommand ( { \"connPoolStats\" : 1 } ) Index db . demo . createIndex ({ name : 1 }) db . demo . createIndex ({ name : 1 },{ background : true }) db . demo . dropIndex ({ name : 1 }) db . demo . getIndexes () Array db . getCollection ( 'feat.rammus' ). insertOne ( { name : \"rammus\" } ) db . getCollection ( 'feat.rammus' ). update ( { name : \"rammus\" }, { $addToSet : { tags : { $each : [ \"ban\" , \"hid\" , \"3\" ]}} } ) db . getCollection ( 'feat.rammus' ). update ( { name : \"rammus\" }, { $pull : { tags : { $in : [ \"ban\" , \"3\" ]}} } ) Find db . getCollection ( 'feat.rammus' ). find ( { tags : /cover/i } ) Log db . getCollection ( 'oplog.rs' ). find ({}). sort ({ $natural : - 1 }) Test while true ; do kubectl exec - it mongo - mongos - 0 -- mongo mongo - mongos : 27017 / rammus -- eval \"db.serverStatus().connections;\" ; done ; while true ; do kubectl exec - it mongo - sh0 - 0 -- mongo mongo - sh0 - 0. mongo - sh0 : 27017 / rammus -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - sh0 - 0 -- mongo mongo - sh0 - 1. mongo - sh0 : 27017 / rammus -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - sh0 - 0 -- mongo mongo - sh0 - 2. mongo - sh0 : 27017 / rammus -- eval \"db.serverStatus().connections;\" done ; kubectl exec - it mongo - mongos - 0 -- mongo -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - mongos - 1 -- mongo -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - mongos - 2 -- mongo -- eval \"db.serverStatus().connections;\" Troubleshooting \u00b6 current \u90fd\u662f\u4e00\u6a23\u7684 mongos \u4e0d\u4e00\u5b9a\u9023\u5230\u9019\u500b replica\uff0c\u4e00\u500b replica set \u6709\u4e09\u500b node\uff0c\u6240\u4ee5\u4e09\u500b\u90fd\u8981\u6aa2\u67e5","title":"Mongo"},{"location":"snippets/mongo/#cluster-setup","text":"rs . initiate ( { _id : \"<replSetName>\" , configsvr : true , members : [ { _id : 0 , host : \"cfg1.example.net:27019\" }, { _id : 1 , host : \"cfg2.example.net:27019\" , priority : 0.5 }, { _id : 2 , host : \"cfg3.example.net:27019\" , priority : 0.5 } ] } ) rs . initiate ( { _id : \"configReplSet\" , configsvr : true , members : [ { _id : 0 , host : \"mongo-configsvr-0.mongo-configsvr:27019\" }, { _id : 1 , host : \"mongo-configsvr-1.mongo-configsvr:27019\" , priority : 0.5 }, { _id : 2 , host : \"mongo-configsvr-2.mongo-configsvr:27019\" , priority : 0.5 } ] } ) rs . initiate ( { _id : \"rs0\" , members : [ { _id : 0 , host : \"mongo-sh0-0.mongo-sh0:27017\" }, { _id : 1 , host : \"mongo-sh0-1.mongo-sh0:27017\" , priority : 0.5 }, { _id : 2 , host : \"mongo-sh0-2.mongo-sh0:27017\" , priority : 0.5 } ] } ) sh . addShard ( \"<replSetName>/s1-mongo1.example.net:27017\" ) sh . addShard ( \"rs0/mongo-sh0-0.mongo-sh0:27017\" ) rs . initiate () rs . status () rs . isMaster () rs . config () sh . status () rs . reconfig ( rs . config (),{ force : true }) mongo -- port 27019 -- eval \"rs.reconfig(rs.config(),{force:true})\"","title":"Cluster setup"},{"location":"snippets/mongo/#config","text":"db . getMongo (). setReadPref ( 'secondaryPreferred' )","title":"Config"},{"location":"snippets/mongo/#usage","text":"use myNewDatabase db . myCollection . insertOne ( { x : 1 } ) db . myCollection . find () Connection pools db . serverStatus (). connections db . currentOp ( true ) db . runCommand ( { \"connPoolStats\" : 1 } ) Index db . demo . createIndex ({ name : 1 }) db . demo . createIndex ({ name : 1 },{ background : true }) db . demo . dropIndex ({ name : 1 }) db . demo . getIndexes () Array db . getCollection ( 'feat.rammus' ). insertOne ( { name : \"rammus\" } ) db . getCollection ( 'feat.rammus' ). update ( { name : \"rammus\" }, { $addToSet : { tags : { $each : [ \"ban\" , \"hid\" , \"3\" ]}} } ) db . getCollection ( 'feat.rammus' ). update ( { name : \"rammus\" }, { $pull : { tags : { $in : [ \"ban\" , \"3\" ]}} } ) Find db . getCollection ( 'feat.rammus' ). find ( { tags : /cover/i } ) Log db . getCollection ( 'oplog.rs' ). find ({}). sort ({ $natural : - 1 }) Test while true ; do kubectl exec - it mongo - mongos - 0 -- mongo mongo - mongos : 27017 / rammus -- eval \"db.serverStatus().connections;\" ; done ; while true ; do kubectl exec - it mongo - sh0 - 0 -- mongo mongo - sh0 - 0. mongo - sh0 : 27017 / rammus -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - sh0 - 0 -- mongo mongo - sh0 - 1. mongo - sh0 : 27017 / rammus -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - sh0 - 0 -- mongo mongo - sh0 - 2. mongo - sh0 : 27017 / rammus -- eval \"db.serverStatus().connections;\" done ; kubectl exec - it mongo - mongos - 0 -- mongo -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - mongos - 1 -- mongo -- eval \"db.serverStatus().connections;\" kubectl exec - it mongo - mongos - 2 -- mongo -- eval \"db.serverStatus().connections;\"","title":"Usage"},{"location":"snippets/mongo/#troubleshooting","text":"current \u90fd\u662f\u4e00\u6a23\u7684 mongos \u4e0d\u4e00\u5b9a\u9023\u5230\u9019\u500b replica\uff0c\u4e00\u500b replica set \u6709\u4e09\u500b node\uff0c\u6240\u4ee5\u4e09\u500b\u90fd\u8981\u6aa2\u67e5","title":"Troubleshooting"},{"location":"snippets/nginx/","text":"nginx -s reload","title":"Nginx"},{"location":"snippets/visual-studio/","text":"Visual Studio \u00b6 Python env \u00b6 https://code.visualstudio.com/docs/python/environments python3 -m venv .venv Note Command + Shift + P -> Python: Select Interpreter","title":"Visual Studio"},{"location":"snippets/visual-studio/#visual-studio","text":"","title":"Visual Studio"},{"location":"snippets/visual-studio/#python-env","text":"https://code.visualstudio.com/docs/python/environments python3 -m venv .venv Note Command + Shift + P -> Python: Select Interpreter","title":"Python env"},{"location":"today-i-learned/2019/","text":"What I learned in 2019. 2019-12-05 \u00b6 \u5728 local \u958b\u767c https application, service, webhook \u00b6 ref: https://ngrok.com/ brew cask install ngrok ngrok authtoken xxxx ngrok http 4000 2019-05-21 \u00b6 MongoDB Production Configuration \u00b6 ref: https://docs.mongodb.com/manual/core/sharded-cluster-components/ Deploy Config Servers as a 3 member replica set Deploy each Shard as a 3 member replica set Deploy one or more mongos routers","title":"2019"},{"location":"today-i-learned/2019/#2019-12-05","text":"","title":"2019-12-05"},{"location":"today-i-learned/2019/#local-https-application-service-webhook","text":"ref: https://ngrok.com/ brew cask install ngrok ngrok authtoken xxxx ngrok http 4000","title":"\u5728 local \u958b\u767c https application, service, webhook"},{"location":"today-i-learned/2019/#2019-05-21","text":"","title":"2019-05-21"},{"location":"today-i-learned/2019/#mongodb-production-configuration","text":"ref: https://docs.mongodb.com/manual/core/sharded-cluster-components/ Deploy Config Servers as a 3 member replica set Deploy each Shard as a 3 member replica set Deploy one or more mongos routers","title":"MongoDB Production Configuration"},{"location":"today-i-learned/2020/","text":"What I learned in 2020. 2020-03-14 \u00b6 Find other LAN user's IP \u00b6 arp -a 2020-03-13 \u00b6 \u4e2d\u570b\u7684\u6e2c\u901f\u7db2\u7ad9 https://www.17ce.com/ \u00b6 \u53ef\u4ee5\u6e2c\u8a66 CDN \u6548\u679c benchmark warm up 2020-03-12 \u00b6 dnsmasq: unsupported option (check that dnsmasq was compiled with DHCP/TFTP/DNSSEC/DBus support) \u00b6 Solution apk --no-cache add dnsmasq-dnssec \u9019\u500b\u932f\u8aa4\u767c\u751f\u5728: \u4f7f\u7528 alpine linux apk add dnsmasq Enable dnssec # /etc/dnsmasq.conf dnssec conf-file = /usr/share/dnsmasq/trust-anchors.conf dnssec-check-unsigned or # /etc/dnsmasq.conf dnssec trust-anchor=.,19036,8,2,49AAC11D7B6F6446702E54A1607371607A1A41855200FD2CE1CDDE32F24E8FB5 trust-anchor=.,20326,8,2,E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D dnssec-check-unsigned Success nsmasq_1 | dnsmasq: started, version 2 .80 cachesize 150 dnsmasq_1 | dnsmasq: compile time options: IPv6 GNU-getopt no-DBus no-i18n no-IDN DHCP DHCPv6 no-Lua TFTP no-conntrack ipset auth DNSSEC loop-detect inotify dumpfile dnsmasq_1 | dnsmasq: DNSSEC validation enabled dnsmasq_1 | dnsmasq: configured with trust anchor for <root> keytag 20326 dnsmasq_1 | dnsmasq: configured with trust anchor for <root> keytag 19036 Parsing dnssec anchors in shell script(bash) \u00b6 ref: https://stackoverflow.com/questions/19908777/curl-and-xmllint-pipe https://data.iana.org/root-anchors/root-anchors.xml curl - s https : // data . iana . org / root - anchors / root - anchors . xml | \\ xmllint --format --xpath 'concat(\"trust-anchor=.,\", /TrustAnchor/KeyDigest[1]/KeyTag, \",\", /TrustAnchor/KeyDigest[1]/Algorithm, \",\",/TrustAnchor/KeyDigest[1]//DigestType, \",\", /TrustAnchor/KeyDigest[1]/Digest)' - curl - s https : // data . iana . org / root - anchors / root - anchors . xml | \\ xmllint --format --xpath 'concat(\"trust-anchor=.,\", /TrustAnchor/KeyDigest[2]/KeyTag, \",\", /TrustAnchor/KeyDigest[2]/Algorithm, \",\",/TrustAnchor/KeyDigest[2]//DigestType, \",\", /TrustAnchor/KeyDigest[2]/Digest)' - Commands of testing domain \u00b6 apk add bind-tools nslookup swag.live localhost nslookup swag.live 127 .0.0.1 dig @localhost swag.live dig @127.0.0.1 swag.live dig @8.8.8.8 swag.live dig +trace swag.live dig +short swag.live ns dig @dnsmasq +dnssec swag.live dig @dnsmasq +dnssec google.com 2020-03-11 \u00b6 Check multiple variables are not None in Python \u00b6 ref: https://stackoverflow.com/questions/42360956/what-is-the-most-pythonic-way-to-check-if-multiple-variables-are-not-none params = os . getenv ( 'PARAMS' ) sid = os . getenv ( 'SID' ) skey = os . getenv ( 'SKEY' ) if None in ( params , sid , skey ): print ( \"Must have SID, SKEY, PARAMS\" ) exit ( 1 ) 2020-03-10 \u00b6 GCS roles \u00b6 Storage Object Admin resourcemanager.projects.get resourcemanager.projects.list storage.objects.create storage.objects.delete storage.objects.get storage.objects.getIamPolicy storage.objects.list storage.objects.setIamPolicy storage.objects.update Storage Object Creator resourcemanager.projects.get resourcemanager.projects.list storage.objects.create Storage Object Viewer resourcemanager.projects.get resourcemanager.projects.list storage.objects.get storage.objects.list 2020-03-09 \u00b6 Get nth line of stdout on linux \u00b6 ref: https://stackoverflow.com/questions/1429556/command-to-get-nth-line-of-stdout ls -l | sed -n 2p ls -l | head -2 | tail -1 Sort GCS (google cloud storage) objects by date \u00b6 ref: https://stackoverflow.com/a/51709554/3854890 gsutil ls -l gs:// [ bucket-name ] / | sort -r -k 2 Example: ~ gsutil ls -l gs://rammus.cf/download | sort -r -k 2 62786148 2020 -03-06T05:52:53Z gs://rammus.cf/download/3.0.2.8087.086886.apk 62732280 2020 -03-04T03:07:33Z gs://rammus.cf/download/3.0.1-8070.apk 62729059 2020 -03-02T16:25:22Z gs://rammus.cf/download/3_0_1_8ca354.apk 11 2020 -03-02T16:25:03Z gs://rammus.cf/download/ Measuring kubernetes dns \u00b6 bash-5.0# time ( for i in { 1 ..100 } ; do host -U echoserver.ops > /dev/null ; done ) real 0m1.150s user 0m0.445s sys 0m0.278s bash-5.0# time ( for i in { 1 ..100 } ; do host -U echoserver.ops.svc.cluster.local > /dev/null ; done ) real 0m1.762s user 0m0.463s sys 0m0.362s bash-5.0# host -v echoserver.ops Trying \"echoserver.ops.ops.svc.cluster.local\" Trying \"echoserver.ops.svc.cluster.local\" bash-5.0# host -v echoserver.ops.svc.cluster.local Trying \"echoserver.ops.svc.cluster.local.ops.svc.cluster.local\" Trying \"echoserver.ops.svc.cluster.local.svc.cluster.local\" Trying \"echoserver.ops.svc.cluster.local.cluster.local\" Trying \"echoserver.ops.svc.cluster.local.google.internal\" Trying \"echoserver.ops.svc.cluster.local\" bash-5.0# cat /etc/resolv.conf nameserver 10 .24.0.10 search ops.svc.cluster.local svc.cluster.local cluster.local google.internal options ndots:5 2020-03-06 \u00b6 How does python redis library query a DNS record? \u00b6 How does UDP request receiving responses. \u00b6 SOCK_STREAM: TCP SOCK_DGRAM: UDP https://stackoverflow.com/questions/1815030/receiving-a-response-through-udp Client emits UDP packet. Router passes UDP packet to the Internet. Router remembers that client sent a UDP packet to server, and establishes a mapping in its memory. Server sends a UDP packet, probably on the same port. Router receives packet, and checks mapping to find client talked to server recently. Router passes packet to client. https://ns1.com/resources/dns-protocol DNS communication occurs via two types of messages: queries and replies. Both DNS query format and reply format consist of the following sections: The header section contains Identification; Flags; Number of questions; Number of answers; Number of authority resource records (RRs); and Number of additional resource records. The flag field contains sections of one or four bits, indicating type of message, whether the name server is authoritative; whether the query is recursive or not, whether request was truncated, and status. The question section contains the domain name and type of record (A, AAAA, MX, TXT, etc.) being resolved. Each label in the domain name is prefixed by its length. The answer section has the resource records of the queried name. http://www-inf.int-evry.fr/~hennequi/CoursDNS/NOTES-COURS_eng/msg.html Weave Scope - \u76e3\u63a7 kubernetes \u7684\u5de5\u5177 \u00b6 ref: https://www.weave.works/docs/scope/latest/installing/#kubernetes \u5b89\u88dd Weave Scope kubectl apply -f \"https://cloud.weave.works/k8s/scope.yaml?k8s-version= $( kubectl version | base64 | tr -d '\\n' ) \" Expose \u670d\u52d9\u5230 localhost kubectl port-forward -n weave service/weave-scope-app 4040:80 open -a \"Google Chrome\" \"http://localhost:4040\" 2020-03-05 \u00b6 Try to resolve a domain in kubernetes \u00b6 Default /etc/resolv.conf is like: nameserver 10.24.0.10 search default.svc.cluster.local svc.cluster.local cluster.local google.internal options ndots:5 \u5c11\u65bc 5 \u500b dot (.) \u5c07\u6703\u5148\u641c\u5c0b search default.svc.cluster.local svc.cluster.local cluster.local google.internal > host -v a.a.a.www.google.com Trying \"a.a.a.www.google.com\" > host -v a.a.www.google.com Trying \"a.a.www.google.com.ops.svc.cluster.local\" Trying \"a.a.www.google.com.svc.cluster.local\" Trying \"a.a.www.google.com.cluster.local\" Trying \"a.a.www.google.com.google.internal\" Trying \"a.a.www.google.com\" > host -v www.google.com Trying \"www.google.com.ops.svc.cluster.local\" Trying \"www.google.com.svc.cluster.local\" Trying \"www.google.com.cluster.local\" Trying \"www.google.com.google.internal\" Trying \"www.google.com\" 2020-03-04 \u00b6 how-to-perform-ddos-test-as-a-pentester \u00b6 https://pentest.blog/how-to-perform-ddos-test-as-a-pentester/ Install netstress on kali linux \u00b6 apt-get update apt-get install netstress Run kali linux on Kubernetes \u00b6 apiVersion : v1 kind : Pod metadata : name : kali labels : app : kali spec : ## Select node pool in GKE # affinity: # nodeAffinity: # requiredDuringSchedulingIgnoredDuringExecution: # nodeSelectorTerms: # - matchExpressions: # - key: cloud.google.com/gke-nodepool # operator: In # values: # - \"pool-1\" containers : - image : kalilinux/kali command : [ \"/bin/sh\" , \"-c\" ] args : - | tail -f /dev/null imagePullPolicy : IfNotPresent name : kali restartPolicy : Never GKE NodeLocal DNSCache \u00b6 https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache Base on CoreDNS Install dnsperf on alpine \u00b6 ref: - https://github.com/ssro/dnsperf/blob/master/Dockerfile - https://github.com/guessi/docker-dnsperf/blob/master/bench/k8s-dnsperf-bench.yaml DNSPERF = dnsperf-2.3.2 apk add --update --no-cache --virtual deps wget g++ make bind-dev openssl-dev libxml2-dev libcap-dev json-c-dev krb5-dev protobuf-c-dev fstrm-dev \\ && apk add --update --no-cache bind libcrypto1.1 \\ && wget https://www.dns-oarc.net/files/dnsperf/ $DNSPERF .tar.gz \\ && tar zxvf $DNSPERF .tar.gz \\ && cd $DNSPERF \\ && sh configure \\ && make \\ && strip ./src/dnsperf ./src/resperf \\ && make install echo \"kube-dns.kube-system.svc.cluster.local A\" > records.txt echo \"echoserver.ops.svc.cluster.local A\" > records.txt dnsperf -l 100 \\ -s 10 .20.5.17 \\ -T 20 \\ -c 20 \\ -q 10000 \\ -Q 10000 \\ -S 5 \\ -d records.txt -l run for at most this many seconds -s the server -T the number of threads to run -c the number of clients to act as to query (default: 127.0.0.1) -q the maximum number of queries outstanding (default: 100) -Q limit the number of queries per second -S print qps statistics every N seconds -d the input data file (default: stdin) 2020-03-03 \u00b6 Open Google Chrome browser in Mac terminal \u00b6 open -a \"Google Chrome\" \"http://localhost:5601\" 2020-03-02 \u00b6 Create a temporary pod to debug and kill itself after an hour \u00b6 apiVersion : v1 kind : Pod metadata : name : busybox1 labels : app : busybox1 spec : containers : # - image: busybox - image : alpine:3.11 command : - sleep - \"3600\" imagePullPolicy : IfNotPresent name : busybox restartPolicy : Never DNS load testing in Alpine \u00b6 apk add gcc g++ make libffi-dev openssl-dev git git clone https://github.com/jedisct1/dnsblast.git cd dnsblast && make #./dnsblast [host] [times] [request per second] ./dnsblast kube-dns.kube-system 10000 1000 ./dnsblast 127 .0.0.1 10000 1000 The command above will break kube-dns. There are 5 kube-dns pods, but only one is receiving request. Caused by iptable and UDP. dnsmasq I0302 08 :47:01.002440 1 nanny.go:146 [] dnsmasq [ 23 ] : Maximum number of concurrent DNS queries reached ( max: 1500 ) sidecar W0302 08 :47:01.248582 1 server.go:64 [] Error getting metrics from dnsmasq: read udp 127 .0.0.1:37986->127.0.0.1:53: i/o timeout GKE v1.13.x uses kube-dns rather than core-dns. \u00b6 ref: https://cloud.google.com/kubernetes-engine/docs/release-notes#new_features_6 GKE is using kube- rather than core-dns. No idea why they are doing this. Install gcc compiler in Alpine \u00b6 ref: https://github.com/nange/blog/issues/3 apk add gcc g++ make libffi-dev openssl-dev echo -n \u00b6 https://linux.die.net/man/1/echo -n do not output the trailing newline 2020-02-27 \u00b6 Get GitHub user info \u00b6 https://developer.github.com/v3/#authentication curl -u \"username\" https://api.github.com/user curl -H \"Authorization: token $PAT \" https://api.github.com/user 2020-02-26 \u00b6 Use CloudFlare WARP as VPN on Mac/PC \u00b6 https://community.cloudflare.com/t/tutorial-how-to-use-cloudflare-warp-on-your-mac/129919?fbclid=IwAR3OlvJrv2EW3KoH3GlDA-gURM5BgPKiaP5RDjjlgBHyYpKWbryZzbrPDGw WARP (CloudFlare VPN) is made from Wireguard. Therefore we can generate a Wirrguard config from CloudFlare and use it on PC. Refresh/Clean CDN cache on Tencent Cloud \u00b6 https://console.cloud.tencent.com/cdn/refresh Just type what url you want to refresh. You might have to verify by doing a request from a location with a Cloudflare edge \u00b6 I tested it on https://tools.pingdom.com/ test in Tokyo CloudFlare/Google CDN both have edges GCS hosting need more DNS time: 40 ms 2020-02-24 \u00b6 CloudFlare worker - Can't resovle/find domain \u00b6 Need to manully add this record to route worker. ref: https://community.cloudflare.com/t/a-record-name-for-worker/98841 Solution Add an A record to 192.0.2.1 CloudFlare worker - how to handle SPA \u00b6 I found there's 404 when I tried to refresh in other page like /faq. ref: https://stackoverflow.com/questions/58432345/cloudflare-workers-spa-with-vuejs options . mapRequestToAsset = req => { // First let's apply the default handler, which we imported from // '@cloudflare/kv-asset-handler' at the top of the file. We do // this because the default handler already has logic to detect // paths that should map to HTML files, for which it appends // `/index.html` to the path. req = mapRequestToAsset ( req ) // Now we can detect if the default handler decided to map to // index.html in some specific directory. if ( req . url . endsWith ( '/index.html' )) { // Indeed. Let's change it to instead map to the root `/index.html`. // This avoids the need to do a redundant lookup that we know will // fail. return new Request ( ` ${ new URL ( req . url ). origin } /index.html` , req ) } else { // The default handler decided this is not an HTML page. It's probably // an image, CSS, or JS file. Leave it as-is. return req } } 2020-02-21 \u00b6 Multiple static IP in a load balancer \u00b6 Steps: Manual create ip addresses. Assign ip addresses to load balancer frontend Use externalIPs instead of loadBalancerIP kind : Service apiVersion : v1 metadata : name : dnsmasq spec : selector : name : dnsmasq type : LoadBalancer externalIPs : - a.a.a.a - a.a.a.b ports : - name : dnsmasq-udp port : 53 protocol : UDP targetPort : dnsmasq-udp # loadBalancerIP: a.a.a.a Testing HPA high memory \u00b6 ref: https://github.com/feiskyer/kubernetes-handbook/blob/master/examples/hpa-memory.yaml apiVersion : autoscaling/v2beta1 kind : HorizontalPodAutoscaler metadata : name : nginx-hpa spec : scaleTargetRef : apiVersion : extensions/v1beta1 kind : Deployment name : dnsmasq minReplicas : 1 maxReplicas : 5 metrics : - type : Resource resource : name : memory targetAverageUtilization : 60 and get in a container $ kubectl exec -it dnsmasq-5964d6fdc-2ktt8 sh generate high memory usage $ yes | tr \\\\ n x | head -c 100m | grep n About Kubernetes HPA(Horizontal Pod Autoscaler) \u00b6 ref: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )] \u6bcf 15 \u79d2\u6aa2\u67e5\u4e00\u6b21 \u9810\u8a2d downscale: 5m 2020-02-19 \u00b6 Use environment from parent process in Nginx(OpenResty) \u00b6 \u5728 nginx \u8b80\u53d6\u74b0\u5883\u8b8a\u6578\u7684\u6b63\u78ba\u65b9\u6cd5: \u5148\u5728 root block export \u8b8a\u6578 \u4f7f\u7528 lua os.getenv(\"MY_ENV\")) env MY_ENV; env PATH; http { server { location / { content_by_lua_block { ngx.say(os.getenv(\"MY_ENV\")); ngx.say(os.getenv(\"PATH\")); } } } } cannot create an external load balancer with mix protocols \u00b6 The Service \"dnsmasq\" is invalid: spec.ports: Invalid value: [] core.ServicePort { core.ServicePort { Name: \"dnsmasq\" , Protocol: \"TCP\" , Port:53, TargetPort:intstr.IntOrString { Type:1, IntVal:0, StrVal: \"dnsmasq\" } , NodePort:0 } , core.ServicePort { Name: \"dnsmasq-udp\" , Protocol: \"UDP\" , Port:53, TargetPort:intstr.IntOrString { Type:1, IntVal:0, StrVal: \"dnsmasq-udp\" } , NodePort:0 }} : cannot create an external load balancer with mix protocols 2020-02-18 \u00b6 Try docker-compose health check \u00b6 https://github.com/peter-evans/docker-compose-healthcheck healthcheck : test : [ \"CMD-SHELL\" , \"pg_isready -U postgres\" ] interval : 10 s timeout : 5 s retries : 5 Docker \u66f4\u65b0\u5f8c\u8df3\u51fa docker-credential-osxkeychain \u60f3\u4f7f\u7528\u9470\u5319\u5708 ci-db \u00b6 https://github.com/docker/for-mac/issues/3805#issuecomment-518619953 Solution Open ~/.docker/config.json Set \"credsStore\":\"\" How to use cc-by-sa license \u00b6 Plain text: https://creativecommons.org/licenses/by-sa/4.0/legalcode.txt Image: <a rel= \"license\" href= \"http://creativecommons.org/licenses/by-sa/4.0/\" ><img alt= \"Creative Commons License\" style= \"border-width:0\" src= \"https://i.creativecommons.org/l/by-sa/4.0/88x31.png\" /></a> [![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/) Print a colorful text in terminal \u00b6 ANSI - \u8f38\u51fa\u6587\u5b57\u8b8a\u8272 echo -e \"\\e[1;31mHello\\e[0m World\" Render a chart inside markdown with canvasjs \u00b6 window.onload = function () { var limit = 50000; var y = 100; var data = []; var dataSeries = { type: \"line\" }; var dataPoints = []; for (var i = 0; i < limit; i += 1) { y += Math.round(Math.random() * 10 - 5); dataPoints.push({ x: i, y: y }); } dataSeries.dataPoints = dataPoints; data.push(dataSeries); //Better to construct options first and then pass it as a parameter var options = { zoomEnabled: true, animationEnabled: true, title: { text: \"Try Zooming - Panning\" }, axisY: { includeZero: false, lineThickness: 1 }, data: data // random data }; var chart = new CanvasJS.Chart(\"chartContainer\", options); chart.render(); } 2020-02-15 \u00b6 Restart a kubernetes resource without down time and using same config(yaml) \u00b6 Kubernetes >= 1.15 ref: https://github.com/kubernetes/kubernetes/issues/33664#issuecomment-497242094 Gracefully rolling restart deployment. kubectl rollout restart deployment/my-sites --namespace = default \bRun commnad without(ignoring) output \u00b6 https://askubuntu.com/questions/474556/hiding-output-of-a-command command > /dev/null 2 > & 1 command > & /dev/null Example: Still show errors when command failed. $ edho hi > /dev/null zsh: command not found: edho Don't show error even when command failed. $ edho hi > & /dev/null 2020-02-13 \u00b6 \u5728 docker-compose \u4e2d\u7684\u5bb9\u5668\u4e92\u76f8\u6e9d\u901a \u00b6 service name \u6703\u88ab\u7d81\u5230 DNS\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 service name \u7576\u4f5c host version : '3' services : redis : image : \"redis:alpine\" ports : - \"6379:6379\" celery : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis celery-2 : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis $ docker network ls NETWORK ID NAME DRIVER SCOPE 01681ec52fea celery_default bridge local $ docker exec -it celery_celery_1 bash user@dcd8cf4a9d04:~$ ping celery-2 PING celery-2 ( 192 .168.0.4 ) : 56 data bytes 64 bytes from 192 .168.0.4: icmp_seq = 0 ttl = 64 time = 0 .162 ms 64 bytes from 192 .168.0.4: icmp_seq = 1 ttl = 64 time = 0 .223 ms ^C--- celery-2 ping statistics --- 2 packets transmitted, 2 packets received, 0 % packet loss round-trip min/avg/max/stddev = 0 .162/0.193/0.223/0.031 ms user@dcd8cf4a9d04:~$ ping celery-3 ping: unknown host mkdocs minify html got error \u00b6 mkdocs.yaml plugins : - minify : minify_html : true Bug print \"htmlmin option \" + key + \" not recognized\" ^ SyntaxError: Missing parentheses in call to 'print' . Did you mean print ( \"htmlmin option \" + key + \" not recognized\" ) ? Solution ref: https://github.com/byrnereese/mkdocs-minify-plugin/issues/8 Upgrade mkdocs-minify-plugin>= 0.2.3","title":"2020"},{"location":"today-i-learned/2020/#2020-03-14","text":"","title":"2020-03-14"},{"location":"today-i-learned/2020/#find-other-lan-users-ip","text":"arp -a","title":"Find other LAN user's IP"},{"location":"today-i-learned/2020/#2020-03-13","text":"","title":"2020-03-13"},{"location":"today-i-learned/2020/#httpswww17cecom","text":"\u53ef\u4ee5\u6e2c\u8a66 CDN \u6548\u679c benchmark warm up","title":"\u4e2d\u570b\u7684\u6e2c\u901f\u7db2\u7ad9 https://www.17ce.com/"},{"location":"today-i-learned/2020/#2020-03-12","text":"","title":"2020-03-12"},{"location":"today-i-learned/2020/#dnsmasq-unsupported-option-check-that-dnsmasq-was-compiled-with-dhcptftpdnssecdbus-support","text":"Solution apk --no-cache add dnsmasq-dnssec \u9019\u500b\u932f\u8aa4\u767c\u751f\u5728: \u4f7f\u7528 alpine linux apk add dnsmasq Enable dnssec # /etc/dnsmasq.conf dnssec conf-file = /usr/share/dnsmasq/trust-anchors.conf dnssec-check-unsigned or # /etc/dnsmasq.conf dnssec trust-anchor=.,19036,8,2,49AAC11D7B6F6446702E54A1607371607A1A41855200FD2CE1CDDE32F24E8FB5 trust-anchor=.,20326,8,2,E06D44B80B8F1D39A95C0B0D7C65D08458E880409BBC683457104237C7F8EC8D dnssec-check-unsigned Success nsmasq_1 | dnsmasq: started, version 2 .80 cachesize 150 dnsmasq_1 | dnsmasq: compile time options: IPv6 GNU-getopt no-DBus no-i18n no-IDN DHCP DHCPv6 no-Lua TFTP no-conntrack ipset auth DNSSEC loop-detect inotify dumpfile dnsmasq_1 | dnsmasq: DNSSEC validation enabled dnsmasq_1 | dnsmasq: configured with trust anchor for <root> keytag 20326 dnsmasq_1 | dnsmasq: configured with trust anchor for <root> keytag 19036","title":"dnsmasq: unsupported option (check that dnsmasq was compiled with DHCP/TFTP/DNSSEC/DBus support)"},{"location":"today-i-learned/2020/#parsing-dnssec-anchors-in-shell-scriptbash","text":"ref: https://stackoverflow.com/questions/19908777/curl-and-xmllint-pipe https://data.iana.org/root-anchors/root-anchors.xml curl - s https : // data . iana . org / root - anchors / root - anchors . xml | \\ xmllint --format --xpath 'concat(\"trust-anchor=.,\", /TrustAnchor/KeyDigest[1]/KeyTag, \",\", /TrustAnchor/KeyDigest[1]/Algorithm, \",\",/TrustAnchor/KeyDigest[1]//DigestType, \",\", /TrustAnchor/KeyDigest[1]/Digest)' - curl - s https : // data . iana . org / root - anchors / root - anchors . xml | \\ xmllint --format --xpath 'concat(\"trust-anchor=.,\", /TrustAnchor/KeyDigest[2]/KeyTag, \",\", /TrustAnchor/KeyDigest[2]/Algorithm, \",\",/TrustAnchor/KeyDigest[2]//DigestType, \",\", /TrustAnchor/KeyDigest[2]/Digest)' -","title":"Parsing dnssec anchors in shell script(bash)"},{"location":"today-i-learned/2020/#commands-of-testing-domain","text":"apk add bind-tools nslookup swag.live localhost nslookup swag.live 127 .0.0.1 dig @localhost swag.live dig @127.0.0.1 swag.live dig @8.8.8.8 swag.live dig +trace swag.live dig +short swag.live ns dig @dnsmasq +dnssec swag.live dig @dnsmasq +dnssec google.com","title":"Commands of testing domain"},{"location":"today-i-learned/2020/#2020-03-11","text":"","title":"2020-03-11"},{"location":"today-i-learned/2020/#check-multiple-variables-are-not-none-in-python","text":"ref: https://stackoverflow.com/questions/42360956/what-is-the-most-pythonic-way-to-check-if-multiple-variables-are-not-none params = os . getenv ( 'PARAMS' ) sid = os . getenv ( 'SID' ) skey = os . getenv ( 'SKEY' ) if None in ( params , sid , skey ): print ( \"Must have SID, SKEY, PARAMS\" ) exit ( 1 )","title":"Check multiple variables are not None in Python"},{"location":"today-i-learned/2020/#2020-03-10","text":"","title":"2020-03-10"},{"location":"today-i-learned/2020/#gcs-roles","text":"Storage Object Admin resourcemanager.projects.get resourcemanager.projects.list storage.objects.create storage.objects.delete storage.objects.get storage.objects.getIamPolicy storage.objects.list storage.objects.setIamPolicy storage.objects.update Storage Object Creator resourcemanager.projects.get resourcemanager.projects.list storage.objects.create Storage Object Viewer resourcemanager.projects.get resourcemanager.projects.list storage.objects.get storage.objects.list","title":"GCS roles"},{"location":"today-i-learned/2020/#2020-03-09","text":"","title":"2020-03-09"},{"location":"today-i-learned/2020/#get-nth-line-of-stdout-on-linux","text":"ref: https://stackoverflow.com/questions/1429556/command-to-get-nth-line-of-stdout ls -l | sed -n 2p ls -l | head -2 | tail -1","title":"Get nth line of stdout on linux"},{"location":"today-i-learned/2020/#sort-gcs-google-cloud-storage-objects-by-date","text":"ref: https://stackoverflow.com/a/51709554/3854890 gsutil ls -l gs:// [ bucket-name ] / | sort -r -k 2 Example: ~ gsutil ls -l gs://rammus.cf/download | sort -r -k 2 62786148 2020 -03-06T05:52:53Z gs://rammus.cf/download/3.0.2.8087.086886.apk 62732280 2020 -03-04T03:07:33Z gs://rammus.cf/download/3.0.1-8070.apk 62729059 2020 -03-02T16:25:22Z gs://rammus.cf/download/3_0_1_8ca354.apk 11 2020 -03-02T16:25:03Z gs://rammus.cf/download/","title":"Sort GCS (google cloud storage) objects by date"},{"location":"today-i-learned/2020/#measuring-kubernetes-dns","text":"bash-5.0# time ( for i in { 1 ..100 } ; do host -U echoserver.ops > /dev/null ; done ) real 0m1.150s user 0m0.445s sys 0m0.278s bash-5.0# time ( for i in { 1 ..100 } ; do host -U echoserver.ops.svc.cluster.local > /dev/null ; done ) real 0m1.762s user 0m0.463s sys 0m0.362s bash-5.0# host -v echoserver.ops Trying \"echoserver.ops.ops.svc.cluster.local\" Trying \"echoserver.ops.svc.cluster.local\" bash-5.0# host -v echoserver.ops.svc.cluster.local Trying \"echoserver.ops.svc.cluster.local.ops.svc.cluster.local\" Trying \"echoserver.ops.svc.cluster.local.svc.cluster.local\" Trying \"echoserver.ops.svc.cluster.local.cluster.local\" Trying \"echoserver.ops.svc.cluster.local.google.internal\" Trying \"echoserver.ops.svc.cluster.local\" bash-5.0# cat /etc/resolv.conf nameserver 10 .24.0.10 search ops.svc.cluster.local svc.cluster.local cluster.local google.internal options ndots:5","title":"Measuring kubernetes dns"},{"location":"today-i-learned/2020/#2020-03-06","text":"","title":"2020-03-06"},{"location":"today-i-learned/2020/#how-does-python-redis-library-query-a-dns-record","text":"","title":"How does python redis library query a DNS record?"},{"location":"today-i-learned/2020/#how-does-udp-request-receiving-responses","text":"SOCK_STREAM: TCP SOCK_DGRAM: UDP https://stackoverflow.com/questions/1815030/receiving-a-response-through-udp Client emits UDP packet. Router passes UDP packet to the Internet. Router remembers that client sent a UDP packet to server, and establishes a mapping in its memory. Server sends a UDP packet, probably on the same port. Router receives packet, and checks mapping to find client talked to server recently. Router passes packet to client. https://ns1.com/resources/dns-protocol DNS communication occurs via two types of messages: queries and replies. Both DNS query format and reply format consist of the following sections: The header section contains Identification; Flags; Number of questions; Number of answers; Number of authority resource records (RRs); and Number of additional resource records. The flag field contains sections of one or four bits, indicating type of message, whether the name server is authoritative; whether the query is recursive or not, whether request was truncated, and status. The question section contains the domain name and type of record (A, AAAA, MX, TXT, etc.) being resolved. Each label in the domain name is prefixed by its length. The answer section has the resource records of the queried name. http://www-inf.int-evry.fr/~hennequi/CoursDNS/NOTES-COURS_eng/msg.html","title":"How does UDP request receiving responses."},{"location":"today-i-learned/2020/#weave-scope-kubernetes","text":"ref: https://www.weave.works/docs/scope/latest/installing/#kubernetes \u5b89\u88dd Weave Scope kubectl apply -f \"https://cloud.weave.works/k8s/scope.yaml?k8s-version= $( kubectl version | base64 | tr -d '\\n' ) \" Expose \u670d\u52d9\u5230 localhost kubectl port-forward -n weave service/weave-scope-app 4040:80 open -a \"Google Chrome\" \"http://localhost:4040\"","title":"Weave Scope - \u76e3\u63a7 kubernetes \u7684\u5de5\u5177"},{"location":"today-i-learned/2020/#2020-03-05","text":"","title":"2020-03-05"},{"location":"today-i-learned/2020/#try-to-resolve-a-domain-in-kubernetes","text":"Default /etc/resolv.conf is like: nameserver 10.24.0.10 search default.svc.cluster.local svc.cluster.local cluster.local google.internal options ndots:5 \u5c11\u65bc 5 \u500b dot (.) \u5c07\u6703\u5148\u641c\u5c0b search default.svc.cluster.local svc.cluster.local cluster.local google.internal > host -v a.a.a.www.google.com Trying \"a.a.a.www.google.com\" > host -v a.a.www.google.com Trying \"a.a.www.google.com.ops.svc.cluster.local\" Trying \"a.a.www.google.com.svc.cluster.local\" Trying \"a.a.www.google.com.cluster.local\" Trying \"a.a.www.google.com.google.internal\" Trying \"a.a.www.google.com\" > host -v www.google.com Trying \"www.google.com.ops.svc.cluster.local\" Trying \"www.google.com.svc.cluster.local\" Trying \"www.google.com.cluster.local\" Trying \"www.google.com.google.internal\" Trying \"www.google.com\"","title":"Try to resolve a domain in kubernetes"},{"location":"today-i-learned/2020/#2020-03-04","text":"","title":"2020-03-04"},{"location":"today-i-learned/2020/#how-to-perform-ddos-test-as-a-pentester","text":"https://pentest.blog/how-to-perform-ddos-test-as-a-pentester/","title":"how-to-perform-ddos-test-as-a-pentester"},{"location":"today-i-learned/2020/#install-netstress-on-kali-linux","text":"apt-get update apt-get install netstress","title":"Install netstress on kali linux"},{"location":"today-i-learned/2020/#run-kali-linux-on-kubernetes","text":"apiVersion : v1 kind : Pod metadata : name : kali labels : app : kali spec : ## Select node pool in GKE # affinity: # nodeAffinity: # requiredDuringSchedulingIgnoredDuringExecution: # nodeSelectorTerms: # - matchExpressions: # - key: cloud.google.com/gke-nodepool # operator: In # values: # - \"pool-1\" containers : - image : kalilinux/kali command : [ \"/bin/sh\" , \"-c\" ] args : - | tail -f /dev/null imagePullPolicy : IfNotPresent name : kali restartPolicy : Never","title":"Run kali linux on Kubernetes"},{"location":"today-i-learned/2020/#gke-nodelocal-dnscache","text":"https://cloud.google.com/kubernetes-engine/docs/how-to/nodelocal-dns-cache Base on CoreDNS","title":"GKE NodeLocal DNSCache"},{"location":"today-i-learned/2020/#install-dnsperf-on-alpine","text":"ref: - https://github.com/ssro/dnsperf/blob/master/Dockerfile - https://github.com/guessi/docker-dnsperf/blob/master/bench/k8s-dnsperf-bench.yaml DNSPERF = dnsperf-2.3.2 apk add --update --no-cache --virtual deps wget g++ make bind-dev openssl-dev libxml2-dev libcap-dev json-c-dev krb5-dev protobuf-c-dev fstrm-dev \\ && apk add --update --no-cache bind libcrypto1.1 \\ && wget https://www.dns-oarc.net/files/dnsperf/ $DNSPERF .tar.gz \\ && tar zxvf $DNSPERF .tar.gz \\ && cd $DNSPERF \\ && sh configure \\ && make \\ && strip ./src/dnsperf ./src/resperf \\ && make install echo \"kube-dns.kube-system.svc.cluster.local A\" > records.txt echo \"echoserver.ops.svc.cluster.local A\" > records.txt dnsperf -l 100 \\ -s 10 .20.5.17 \\ -T 20 \\ -c 20 \\ -q 10000 \\ -Q 10000 \\ -S 5 \\ -d records.txt -l run for at most this many seconds -s the server -T the number of threads to run -c the number of clients to act as to query (default: 127.0.0.1) -q the maximum number of queries outstanding (default: 100) -Q limit the number of queries per second -S print qps statistics every N seconds -d the input data file (default: stdin)","title":"Install dnsperf on alpine"},{"location":"today-i-learned/2020/#2020-03-03","text":"","title":"2020-03-03"},{"location":"today-i-learned/2020/#open-google-chrome-browser-in-mac-terminal","text":"open -a \"Google Chrome\" \"http://localhost:5601\"","title":"Open Google Chrome browser in Mac terminal"},{"location":"today-i-learned/2020/#2020-03-02","text":"","title":"2020-03-02"},{"location":"today-i-learned/2020/#create-a-temporary-pod-to-debug-and-kill-itself-after-an-hour","text":"apiVersion : v1 kind : Pod metadata : name : busybox1 labels : app : busybox1 spec : containers : # - image: busybox - image : alpine:3.11 command : - sleep - \"3600\" imagePullPolicy : IfNotPresent name : busybox restartPolicy : Never","title":"Create a temporary pod to debug and kill itself after an hour"},{"location":"today-i-learned/2020/#dns-load-testing-in-alpine","text":"apk add gcc g++ make libffi-dev openssl-dev git git clone https://github.com/jedisct1/dnsblast.git cd dnsblast && make #./dnsblast [host] [times] [request per second] ./dnsblast kube-dns.kube-system 10000 1000 ./dnsblast 127 .0.0.1 10000 1000 The command above will break kube-dns. There are 5 kube-dns pods, but only one is receiving request. Caused by iptable and UDP. dnsmasq I0302 08 :47:01.002440 1 nanny.go:146 [] dnsmasq [ 23 ] : Maximum number of concurrent DNS queries reached ( max: 1500 ) sidecar W0302 08 :47:01.248582 1 server.go:64 [] Error getting metrics from dnsmasq: read udp 127 .0.0.1:37986->127.0.0.1:53: i/o timeout","title":"DNS load testing in Alpine"},{"location":"today-i-learned/2020/#gke-v113x-uses-kube-dns-rather-than-core-dns","text":"ref: https://cloud.google.com/kubernetes-engine/docs/release-notes#new_features_6 GKE is using kube- rather than core-dns. No idea why they are doing this.","title":"GKE v1.13.x uses kube-dns rather than core-dns."},{"location":"today-i-learned/2020/#install-gcc-compiler-in-alpine","text":"ref: https://github.com/nange/blog/issues/3 apk add gcc g++ make libffi-dev openssl-dev","title":"Install gcc compiler in Alpine"},{"location":"today-i-learned/2020/#echo-n","text":"https://linux.die.net/man/1/echo -n do not output the trailing newline","title":"echo -n"},{"location":"today-i-learned/2020/#2020-02-27","text":"","title":"2020-02-27"},{"location":"today-i-learned/2020/#get-github-user-info","text":"https://developer.github.com/v3/#authentication curl -u \"username\" https://api.github.com/user curl -H \"Authorization: token $PAT \" https://api.github.com/user","title":"Get GitHub user info"},{"location":"today-i-learned/2020/#2020-02-26","text":"","title":"2020-02-26"},{"location":"today-i-learned/2020/#use-cloudflare-warp-as-vpn-on-macpc","text":"https://community.cloudflare.com/t/tutorial-how-to-use-cloudflare-warp-on-your-mac/129919?fbclid=IwAR3OlvJrv2EW3KoH3GlDA-gURM5BgPKiaP5RDjjlgBHyYpKWbryZzbrPDGw WARP (CloudFlare VPN) is made from Wireguard. Therefore we can generate a Wirrguard config from CloudFlare and use it on PC.","title":"Use CloudFlare WARP as VPN on Mac/PC"},{"location":"today-i-learned/2020/#refreshclean-cdn-cache-on-tencent-cloud","text":"https://console.cloud.tencent.com/cdn/refresh Just type what url you want to refresh.","title":"Refresh/Clean CDN cache on Tencent Cloud"},{"location":"today-i-learned/2020/#you-might-have-to-verify-by-doing-a-request-from-a-location-with-a-cloudflare-edge","text":"I tested it on https://tools.pingdom.com/ test in Tokyo CloudFlare/Google CDN both have edges GCS hosting need more DNS time: 40 ms","title":"You might have to verify by doing a request from a location with a Cloudflare edge"},{"location":"today-i-learned/2020/#2020-02-24","text":"","title":"2020-02-24"},{"location":"today-i-learned/2020/#cloudflare-worker-cant-resovlefind-domain","text":"Need to manully add this record to route worker. ref: https://community.cloudflare.com/t/a-record-name-for-worker/98841 Solution Add an A record to 192.0.2.1","title":"CloudFlare worker - Can't resovle/find domain"},{"location":"today-i-learned/2020/#cloudflare-worker-how-to-handle-spa","text":"I found there's 404 when I tried to refresh in other page like /faq. ref: https://stackoverflow.com/questions/58432345/cloudflare-workers-spa-with-vuejs options . mapRequestToAsset = req => { // First let's apply the default handler, which we imported from // '@cloudflare/kv-asset-handler' at the top of the file. We do // this because the default handler already has logic to detect // paths that should map to HTML files, for which it appends // `/index.html` to the path. req = mapRequestToAsset ( req ) // Now we can detect if the default handler decided to map to // index.html in some specific directory. if ( req . url . endsWith ( '/index.html' )) { // Indeed. Let's change it to instead map to the root `/index.html`. // This avoids the need to do a redundant lookup that we know will // fail. return new Request ( ` ${ new URL ( req . url ). origin } /index.html` , req ) } else { // The default handler decided this is not an HTML page. It's probably // an image, CSS, or JS file. Leave it as-is. return req } }","title":"CloudFlare worker - how to handle SPA"},{"location":"today-i-learned/2020/#2020-02-21","text":"","title":"2020-02-21"},{"location":"today-i-learned/2020/#multiple-static-ip-in-a-load-balancer","text":"Steps: Manual create ip addresses. Assign ip addresses to load balancer frontend Use externalIPs instead of loadBalancerIP kind : Service apiVersion : v1 metadata : name : dnsmasq spec : selector : name : dnsmasq type : LoadBalancer externalIPs : - a.a.a.a - a.a.a.b ports : - name : dnsmasq-udp port : 53 protocol : UDP targetPort : dnsmasq-udp # loadBalancerIP: a.a.a.a","title":"Multiple static IP in a load balancer"},{"location":"today-i-learned/2020/#testing-hpa-high-memory","text":"ref: https://github.com/feiskyer/kubernetes-handbook/blob/master/examples/hpa-memory.yaml apiVersion : autoscaling/v2beta1 kind : HorizontalPodAutoscaler metadata : name : nginx-hpa spec : scaleTargetRef : apiVersion : extensions/v1beta1 kind : Deployment name : dnsmasq minReplicas : 1 maxReplicas : 5 metrics : - type : Resource resource : name : memory targetAverageUtilization : 60 and get in a container $ kubectl exec -it dnsmasq-5964d6fdc-2ktt8 sh generate high memory usage $ yes | tr \\\\ n x | head -c 100m | grep n","title":"Testing HPA high memory"},{"location":"today-i-learned/2020/#about-kubernetes-hpahorizontal-pod-autoscaler","text":"ref: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale desiredReplicas = ceil[currentReplicas * ( currentMetricValue / desiredMetricValue )] \u6bcf 15 \u79d2\u6aa2\u67e5\u4e00\u6b21 \u9810\u8a2d downscale: 5m","title":"About Kubernetes HPA(Horizontal Pod Autoscaler)"},{"location":"today-i-learned/2020/#2020-02-19","text":"","title":"2020-02-19"},{"location":"today-i-learned/2020/#use-environment-from-parent-process-in-nginxopenresty","text":"\u5728 nginx \u8b80\u53d6\u74b0\u5883\u8b8a\u6578\u7684\u6b63\u78ba\u65b9\u6cd5: \u5148\u5728 root block export \u8b8a\u6578 \u4f7f\u7528 lua os.getenv(\"MY_ENV\")) env MY_ENV; env PATH; http { server { location / { content_by_lua_block { ngx.say(os.getenv(\"MY_ENV\")); ngx.say(os.getenv(\"PATH\")); } } } }","title":"Use environment from parent process in Nginx(OpenResty)"},{"location":"today-i-learned/2020/#cannot-create-an-external-load-balancer-with-mix-protocols","text":"The Service \"dnsmasq\" is invalid: spec.ports: Invalid value: [] core.ServicePort { core.ServicePort { Name: \"dnsmasq\" , Protocol: \"TCP\" , Port:53, TargetPort:intstr.IntOrString { Type:1, IntVal:0, StrVal: \"dnsmasq\" } , NodePort:0 } , core.ServicePort { Name: \"dnsmasq-udp\" , Protocol: \"UDP\" , Port:53, TargetPort:intstr.IntOrString { Type:1, IntVal:0, StrVal: \"dnsmasq-udp\" } , NodePort:0 }} : cannot create an external load balancer with mix protocols","title":"cannot create an external load balancer with mix protocols"},{"location":"today-i-learned/2020/#2020-02-18","text":"","title":"2020-02-18"},{"location":"today-i-learned/2020/#try-docker-compose-health-check","text":"https://github.com/peter-evans/docker-compose-healthcheck healthcheck : test : [ \"CMD-SHELL\" , \"pg_isready -U postgres\" ] interval : 10 s timeout : 5 s retries : 5","title":"Try docker-compose health check"},{"location":"today-i-learned/2020/#docker-docker-credential-osxkeychain-ci-db","text":"https://github.com/docker/for-mac/issues/3805#issuecomment-518619953 Solution Open ~/.docker/config.json Set \"credsStore\":\"\"","title":"Docker \u66f4\u65b0\u5f8c\u8df3\u51fa docker-credential-osxkeychain \u60f3\u4f7f\u7528\u9470\u5319\u5708 ci-db"},{"location":"today-i-learned/2020/#how-to-use-cc-by-sa-license","text":"Plain text: https://creativecommons.org/licenses/by-sa/4.0/legalcode.txt Image: <a rel= \"license\" href= \"http://creativecommons.org/licenses/by-sa/4.0/\" ><img alt= \"Creative Commons License\" style= \"border-width:0\" src= \"https://i.creativecommons.org/l/by-sa/4.0/88x31.png\" /></a> [![](https://i.creativecommons.org/l/by-sa/4.0/88x31.png)](http://creativecommons.org/licenses/by-sa/4.0/)","title":"How to use cc-by-sa license"},{"location":"today-i-learned/2020/#print-a-colorful-text-in-terminal","text":"ANSI - \u8f38\u51fa\u6587\u5b57\u8b8a\u8272 echo -e \"\\e[1;31mHello\\e[0m World\"","title":"Print a colorful text in terminal"},{"location":"today-i-learned/2020/#render-a-chart-inside-markdown-with-canvasjs","text":"window.onload = function () { var limit = 50000; var y = 100; var data = []; var dataSeries = { type: \"line\" }; var dataPoints = []; for (var i = 0; i < limit; i += 1) { y += Math.round(Math.random() * 10 - 5); dataPoints.push({ x: i, y: y }); } dataSeries.dataPoints = dataPoints; data.push(dataSeries); //Better to construct options first and then pass it as a parameter var options = { zoomEnabled: true, animationEnabled: true, title: { text: \"Try Zooming - Panning\" }, axisY: { includeZero: false, lineThickness: 1 }, data: data // random data }; var chart = new CanvasJS.Chart(\"chartContainer\", options); chart.render(); }","title":"Render a chart inside markdown with canvasjs"},{"location":"today-i-learned/2020/#2020-02-15","text":"","title":"2020-02-15"},{"location":"today-i-learned/2020/#restart-a-kubernetes-resource-without-down-time-and-using-same-configyaml","text":"Kubernetes >= 1.15 ref: https://github.com/kubernetes/kubernetes/issues/33664#issuecomment-497242094 Gracefully rolling restart deployment. kubectl rollout restart deployment/my-sites --namespace = default","title":"Restart a kubernetes resource without down time and using same config(yaml)"},{"location":"today-i-learned/2020/#run-commnad-withoutignoring-output","text":"https://askubuntu.com/questions/474556/hiding-output-of-a-command command > /dev/null 2 > & 1 command > & /dev/null Example: Still show errors when command failed. $ edho hi > /dev/null zsh: command not found: edho Don't show error even when command failed. $ edho hi > & /dev/null","title":"\bRun commnad without(ignoring) output"},{"location":"today-i-learned/2020/#2020-02-13","text":"","title":"2020-02-13"},{"location":"today-i-learned/2020/#docker-compose","text":"service name \u6703\u88ab\u7d81\u5230 DNS\uff0c\u53ef\u4ee5\u76f4\u63a5\u4f7f\u7528 service name \u7576\u4f5c host version : '3' services : redis : image : \"redis:alpine\" ports : - \"6379:6379\" celery : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis celery-2 : image : \"celery:4.0.2\" environment : - CELERY_BROKER_URL=redis://redis $ docker network ls NETWORK ID NAME DRIVER SCOPE 01681ec52fea celery_default bridge local $ docker exec -it celery_celery_1 bash user@dcd8cf4a9d04:~$ ping celery-2 PING celery-2 ( 192 .168.0.4 ) : 56 data bytes 64 bytes from 192 .168.0.4: icmp_seq = 0 ttl = 64 time = 0 .162 ms 64 bytes from 192 .168.0.4: icmp_seq = 1 ttl = 64 time = 0 .223 ms ^C--- celery-2 ping statistics --- 2 packets transmitted, 2 packets received, 0 % packet loss round-trip min/avg/max/stddev = 0 .162/0.193/0.223/0.031 ms user@dcd8cf4a9d04:~$ ping celery-3 ping: unknown host","title":"\u5728 docker-compose \u4e2d\u7684\u5bb9\u5668\u4e92\u76f8\u6e9d\u901a"},{"location":"today-i-learned/2020/#mkdocs-minify-html-got-error","text":"mkdocs.yaml plugins : - minify : minify_html : true Bug print \"htmlmin option \" + key + \" not recognized\" ^ SyntaxError: Missing parentheses in call to 'print' . Did you mean print ( \"htmlmin option \" + key + \" not recognized\" ) ? Solution ref: https://github.com/byrnereese/mkdocs-minify-plugin/issues/8 Upgrade mkdocs-minify-plugin>= 0.2.3","title":"mkdocs minify html got error"}]}